# docker-compose.preprod.yml
# Pre-production environment - production build, no hot reload
# External services: PostgreSQL, Redis, S3 (configured in .env)
# Usage: docker compose -f docker-compose.base.yml -f docker-compose.preprod.yml up -d

services:
  #################
  # Backend (FastAPI) - PREPROD (production build)
  #################
  backend:
    container_name: ugm_aicare_backend_preprod
    ports:
      - "${BACKEND_EXTERNAL_PORT:-22001}:8000"
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      COUNSELOR_EMAIL: ${COUNSELOR_EMAIL}
      COUNSELOR_PASSWORD: ${COUNSELOR_PASSWORD}
      COUNSELOR_NAME: ${COUNSELOR_NAME:-Main Counselor}
      FRONTEND_URL: ${FRONTEND_URL}
      BACKEND_URL: ${BACKEND_URL}
      ALLOWED_ORIGINS: "https://aicare.ina17.com,http://localhost:22000,http://127.0.0.1:22000,http://localhost:3000,http://127.0.0.1:3000,http://frontend:3000,http://backend:8000"
      APP_ENV: production
      LANGFUSE_ENABLED: "false"
      LANGFUSE_HOST: "http://langfuse-server:3000"
    restart: unless-stopped
    networks:
      - internal_network_preprod
    dns: 8.8.8.8

  #################
  # Frontend (Next.js) - PREPROD (production build)
  #################
  frontend:
    container_name: ugm_aicare_frontend_preprod
    build:
      target: production
    ports:
      - "${FRONTEND_EXTERNAL_PORT:-22000}:3000"
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    environment:
      NODE_ENV: production
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    restart: unless-stopped
    networks:
      - internal_network_preprod

volumes: {}

networks:
  internal_network_preprod:
    driver: bridge
