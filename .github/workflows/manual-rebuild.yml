name: Manual Docker Rebuild & Redeploy

on:
  workflow_dispatch:
    inputs:
      rebuild_scope:
        description: 'What to rebuild'
        required: true
        type: choice
        options:
          - 'all'
          - 'backend-only'
          - 'frontend-only'
        default: 'all'
      no_cache:
        description: 'Build without Docker cache (force fresh build)'
        required: true
        type: boolean
        default: true
      force_recreate:
        description: 'Force recreate containers (refresh environment variables)'
        required: true
        type: boolean
        default: true
      deploy_monitoring:
        description: 'Deploy monitoring stack'
        required: false
        type: boolean
        default: false
      prune_system:
        description: 'Clean up Docker system before rebuild (remove unused images/containers)'
        required: false
        type: boolean
        default: true

jobs:
  manual-rebuild:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      # ========================================
      # Build Backend (if selected)
      # ========================================
      - name: Build and Push Backend Image
        if: inputs.rebuild_scope == 'all' || inputs.rebuild_scope == 'backend-only'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./infra/docker/backend.Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/ugm-aicare-api:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/ugm-aicare-api:latest
          cache-from: ${{ inputs.no_cache == false && 'type=registry,ref=ghcr.io/${{ github.repository_owner }}/ugm-aicare-api:buildcache' || '' }}
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/ugm-aicare-api:buildcache,mode=max
          no-cache: ${{ inputs.no_cache }}
      
      # ========================================
      # Build Frontend (if selected)
      # ========================================
      - name: Build and Push Frontend Image
        if: inputs.rebuild_scope == 'all' || inputs.rebuild_scope == 'frontend-only'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./infra/docker/frontend.Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/ugm-aicare-web:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/ugm-aicare-web:latest
          build-args: |
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          cache-from: ${{ inputs.no_cache == false && 'type=registry,ref=ghcr.io/${{ github.repository_owner }}/ugm-aicare-web:buildcache' || '' }}
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/ugm-aicare-web:buildcache,mode=max
          no-cache: ${{ inputs.no_cache }}
      
      # ========================================
      # Deploy to Production
      # ========================================
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          GIT_SHA: ${{ github.sha }}
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
          GHCR_REPOSITORY_OWNER: ${{ github.repository_owner }}
          ENV_FILE_PRODUCTION: ${{ secrets.ENV_FILE_PRODUCTION }}
          DEPLOY_MONITORING: ${{ inputs.deploy_monitoring }}
          FORCE_RECREATE: ${{ inputs.force_recreate }}
          PRUNE_SYSTEM: ${{ inputs.prune_system }}
          REBUILD_SCOPE: ${{ inputs.rebuild_scope }}
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT }}
          envs: GIT_SHA,GHCR_TOKEN,GHCR_USER,GHCR_REPOSITORY_OWNER,ENV_FILE_PRODUCTION,DEPLOY_MONITORING,FORCE_RECREATE,PRUNE_SYSTEM,REBUILD_SCOPE
          script: |
            set -e
            
            echo "=========================================="
            echo "üîÑ Manual Rebuild & Redeploy Starting"
            echo "=========================================="
            echo "Git SHA: $GIT_SHA"
            echo "Rebuild Scope: $REBUILD_SCOPE"
            echo "Force Recreate: $FORCE_RECREATE"
            echo "Prune System: $PRUNE_SYSTEM"
            echo "Deploy Monitoring: $DEPLOY_MONITORING"
            echo "=========================================="
            
            # Navigate to project directory
            cd /opt/UGM-AICare
            
            # ========================================
            # 1. System Cleanup (if requested)
            # ========================================
            if [ "$PRUNE_SYSTEM" = "true" ]; then
              echo ""
              echo "üßπ Cleaning up Docker system..."
              
              # Stop all containers first
              echo "Stopping all containers..."
              docker compose -f infra/compose/docker-compose.prod.yml down || true
              
              # Prune containers
              echo "Removing stopped containers..."
              docker container prune -f || true
              
              # Prune images (except running ones)
              echo "Removing dangling images..."
              docker image prune -f || true
              
              # Prune networks
              echo "Removing unused networks..."
              docker network prune -f || true
              
              # Prune volumes (CAREFUL - only unused ones)
              echo "Removing unused volumes..."
              docker volume prune -f || true
              
              # Prune build cache
              echo "Removing build cache..."
              docker builder prune -f --keep-storage=5GB || true
              
              echo "‚úÖ Docker system cleaned"
              
              # Show disk space
              echo ""
              echo "Current disk space:"
              df -h / | awk 'NR==1 || /\/$/'
            fi
            
            # ========================================
            # 2. Update .env File
            # ========================================
            echo ""
            echo "üìù Updating production .env file..."
            echo "$ENV_FILE_PRODUCTION" > .env
            
            # Verify critical variables
            echo "Verifying environment variables..."
            if ! grep -q "ADMIN_EMAIL=" .env; then
              echo "‚ùå ERROR: ADMIN_EMAIL not found in .env!"
              exit 1
            fi
            if ! grep -q "COUNSELOR_EMAIL=" .env; then
              echo "‚ùå ERROR: COUNSELOR_EMAIL not found in .env!"
              exit 1
            fi
            echo "‚úÖ Critical environment variables verified"
            
            # ========================================
            # 3. Docker Login
            # ========================================
            echo ""
            echo "üîê Logging into GitHub Container Registry..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
            echo "‚úÖ Docker login successful"
            
            # ========================================
            # 4. Pull Latest Images
            # ========================================
            echo ""
            echo "üì• Pulling latest Docker images..."
            
            # Convert repository owner to lowercase
            GHCR_REPOSITORY_OWNER_LOWER=$(echo "$GHCR_REPOSITORY_OWNER" | cut -d'/' -f1 | tr '[:upper:]' '[:lower:]')
            
            if [ "$REBUILD_SCOPE" = "all" ] || [ "$REBUILD_SCOPE" = "backend-only" ]; then
              echo "Pulling backend image..."
              docker pull "ghcr.io/${GHCR_REPOSITORY_OWNER_LOWER}/ugm-aicare-api:${GIT_SHA}"
              docker tag "ghcr.io/${GHCR_REPOSITORY_OWNER_LOWER}/ugm-aicare-api:${GIT_SHA}" "ghcr.io/${GHCR_REPOSITORY_OWNER_LOWER}/ugm-aicare-api:latest"
            fi
            
            if [ "$REBUILD_SCOPE" = "all" ] || [ "$REBUILD_SCOPE" = "frontend-only" ]; then
              echo "Pulling frontend image..."
              docker pull "ghcr.io/${GHCR_REPOSITORY_OWNER_LOWER}/ugm-aicare-web:${GIT_SHA}"
              docker tag "ghcr.io/${GHCR_REPOSITORY_OWNER_LOWER}/ugm-aicare-web:${GIT_SHA}" "ghcr.io/${GHCR_REPOSITORY_OWNER_LOWER}/ugm-aicare-web:latest"
            fi
            
            echo "‚úÖ Images pulled successfully"
            
            # ========================================
            # 5. Stop Existing Containers
            # ========================================
            echo ""
            echo "‚èπÔ∏è  Stopping existing containers..."
            docker compose -f infra/compose/docker-compose.prod.yml down
            echo "‚úÖ Containers stopped"
            
            # ========================================
            # 6. Start Services with Force Recreate
            # ========================================
            echo ""
            echo "üöÄ Starting services..."
            
            if [ "$FORCE_RECREATE" = "true" ]; then
              echo "Using --force-recreate to refresh environment variables..."
              
              if [ "$DEPLOY_MONITORING" = "true" ]; then
                docker compose -f infra/compose/docker-compose.prod.yml -f infra/compose/docker-compose.prod-monitoring.yml --env-file .env up -d --force-recreate --remove-orphans
              else
                docker compose -f infra/compose/docker-compose.prod.yml --env-file .env up -d --force-recreate --remove-orphans
              fi
            else
              if [ "$DEPLOY_MONITORING" = "true" ]; then
                docker compose -f infra/compose/docker-compose.prod.yml -f infra/compose/docker-compose.prod-monitoring.yml --env-file .env up -d --remove-orphans
              else
                docker compose -f infra/compose/docker-compose.prod.yml --env-file .env up -d --remove-orphans
              fi
            fi
            
            echo "‚úÖ Services started"
            
            # ========================================
            # 7. Wait for Services to be Healthy
            # ========================================
            echo ""
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15
            
            # Check backend health
            echo "Checking backend health..."
            for i in {1..10}; do
              if docker compose -f infra/compose/docker-compose.prod.yml exec -T backend curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "‚úÖ Backend is healthy"
                break
              fi
              echo "Attempt $i/10: Backend not ready yet..."
              sleep 5
            done
            
            # ========================================
            # 8. Run Database Migrations
            # ========================================
            echo ""
            echo "üóÑÔ∏è  Running database migrations..."
            docker compose -f infra/compose/docker-compose.prod.yml exec -T backend alembic upgrade head
            echo "‚úÖ Migrations completed"
            
            # ========================================
            # 9. Initialize Production Accounts
            # ========================================
            echo ""
            echo "üë• Initializing production accounts..."
            docker compose -f infra/compose/docker-compose.prod.yml exec -T backend python scripts/init_production_accounts.py
            echo "‚úÖ Accounts initialized"
            
            # ========================================
            # 10. Verify Deployment
            # ========================================
            echo ""
            echo "üîç Verifying deployment..."
            
            # Check running containers
            echo "Running containers:"
            docker compose -f infra/compose/docker-compose.prod.yml ps
            
            # Check backend logs for errors
            echo ""
            echo "Recent backend logs:"
            docker compose -f infra/compose/docker-compose.prod.yml logs --tail=50 backend | grep -E "ERROR|WARNING|admin|counselor" || echo "No errors found in recent logs"
            
            # ========================================
            # 11. Summary
            # ========================================
            echo ""
            echo "=========================================="
            echo "‚úÖ Manual Rebuild & Redeploy Complete!"
            echo "=========================================="
            echo "Git SHA: $GIT_SHA"
            echo "Rebuild Scope: $REBUILD_SCOPE"
            echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "=========================================="
            echo ""
            echo "üîó Service URLs:"
            echo "   - Backend API: https://api.aicare.sumbu.xyz"
            echo "   - Frontend: https://aicare.sumbu.xyz"
            echo "   - Health Check: https://api.aicare.sumbu.xyz/health"
            echo ""
            echo "üìä Next Steps:"
            echo "   1. Test login with admin account"
            echo "   2. Verify environment variables are loaded"
            echo "   3. Check application functionality"
            echo "=========================================="
      
      # ========================================
      # Notify on Success
      # ========================================
      - name: Deployment Success Summary
        if: success()
        run: |
          echo "::notice title=Deployment Success::Manual rebuild and redeploy completed successfully for SHA ${{ github.sha }}"
      
      # ========================================
      # Notify on Failure
      # ========================================
      - name: Deployment Failure Summary
        if: failure()
        run: |
          echo "::error title=Deployment Failed::Manual rebuild and redeploy failed for SHA ${{ github.sha }}"
