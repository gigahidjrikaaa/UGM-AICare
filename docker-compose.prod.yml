# docker-compose.prod.yml
# Production environment - minimal, lean, application-only
# External services: PostgreSQL, Redis, S3 (configured in .env)
# Usage: docker compose -f docker-compose.base.yml -f docker-compose.prod.yml up -d

services:
  #################
  # Backend (FastAPI) - PROD
  #################
  backend:
    container_name: ugm_aicare_backend_prod
    ports:
      - "${BACKEND_EXTERNAL_PORT:-22001}:22001"
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    environment:
      PORT: ${PORT:-22001}
      APP_ENV: production
      LANGFUSE_ENABLED: "false"
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
    restart: always
    networks:
      - ugm_aicare_network

  celery-worker:
    container_name: ugm_aicare_celery_worker_prod
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: ["celery", "-A", "app.core.celery_app.celery_app", "worker", "-l", "info"]
    environment:
      PYTHONPATH: /app
      PORT: ${PORT:-22001}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
    restart: always
    networks:
      - ugm_aicare_network

  #################
  # Frontend (Next.js) - PROD
  #################
  frontend:
    container_name: ugm_aicare_frontend_prod
    build:
      target: production
    ports:
      - "${FRONTEND_EXTERNAL_PORT:-22000}:22000"
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 2G
    environment:
      NODE_ENV: production
      PORT: ${PORT:-22000}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      INTERNAL_API_URL: ${INTERNAL_API_URL}
    restart: always
    networks:
      - ugm_aicare_network

volumes: {}

networks:
  ugm_aicare_network:
    driver: bridge
