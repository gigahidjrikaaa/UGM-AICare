"""initial_migration

Revision ID: 5f0351a53f67
Revises: None
Create Date: 2025-11-21 17:45:07.473850

IMPORTANT: All migrations should be IDEMPOTENT.
- Use migration_helpers for existence checks
- Never assume table/column state
- Test both upgrade() and downgrade()
- Document any data transformations
"""

from __future__ import annotations

from typing import Any

from alembic import context, op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# Import migration helpers for idempotent operations
try:
    from alembic import migration_helpers as mh
except ImportError:
    # Fallback if helpers not available
    mh = None

# revision identifiers, used by Alembic.
revision: str = '5f0351a53f67'
down_revision: str | None = None
branch_labels: tuple[str, ...] | None = None
depends_on: tuple[str, ...] | str | None = None


def upgrade() -> None:
    """Apply schema (and optional data) upgrades."""
    schema_upgrade()
    if _should_run_data_migrations():
        data_upgrade()


def downgrade() -> None:
    """Revert schema (and optional data) upgrades."""
    if _should_run_data_migrations():
        data_downgrade()
    schema_downgrade()


def schema_upgrade() -> None:
    """
    Apply schema changes with idempotent checks.
    
    Example patterns:
    
    # Creating tables
    if mh and not mh.table_exists('my_table'):
        op.create_table('my_table', ...)
    
    # Adding columns
    if mh and not mh.column_exists('my_table', 'my_column'):
        op.add_column('my_table', sa.Column('my_column', ...))
    
    # Creating indexes
    if mh and not mh.index_exists('idx_name', 'my_table'):
        op.create_index('idx_name', 'my_table', ['column'])
    
    # Or use helper functions directly:
    if mh:
        mh.add_column_if_not_exists('my_table', sa.Column('my_column', ...))
    """
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('agent_health_logs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('agent_name', sa.String(length=50), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('last_run_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_success_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('error_count', sa.Integer(), nullable=False),
    sa.Column('performance_metrics', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('error_details', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_agent_health_logs_agent_name'), 'agent_health_logs', ['agent_name'], unique=False)
    op.create_index(op.f('ix_agent_health_logs_created_at'), 'agent_health_logs', ['created_at'], unique=False)
    op.create_index(op.f('ix_agent_health_logs_status'), 'agent_health_logs', ['status'], unique=False)
    op.create_table('agent_users',
    sa.Column('id', sa.String(), nullable=False),
    sa.Column('role', sa.Enum('admin', 'counselor', 'operator', 'student', name='agent_role_enum'), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('alerts',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('alert_type', sa.String(length=50), nullable=False),
    sa.Column('severity', sa.String(length=20), nullable=False),
    sa.Column('title', sa.String(length=200), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('entity_type', sa.String(length=50), nullable=True),
    sa.Column('entity_id', sa.String(length=100), nullable=True),
    sa.Column('context_data', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('is_seen', sa.Boolean(), nullable=False),
    sa.Column('seen_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('seen_by', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_alerts_alert_type'), 'alerts', ['alert_type'], unique=False)
    op.create_index(op.f('ix_alerts_created_at'), 'alerts', ['created_at'], unique=False)
    op.create_index(op.f('ix_alerts_entity_id'), 'alerts', ['entity_id'], unique=False)
    op.create_index(op.f('ix_alerts_is_seen'), 'alerts', ['is_seen'], unique=False)
    op.create_index(op.f('ix_alerts_severity'), 'alerts', ['severity'], unique=False)
    op.create_table('appointment_types',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('duration_minutes', sa.Integer(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_appointment_types_id'), 'appointment_types', ['id'], unique=False)
    op.create_table('cbt_modules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_cbt_modules_id'), 'cbt_modules', ['id'], unique=False)
    op.create_table('consents',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('subject_id', sa.String(), nullable=False),
    sa.Column('scope', sa.Enum('ops', 'followup', 'research', name='consent_scope_enum'), nullable=False),
    sa.Column('granted_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('revoked_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('evidence_uri', sa.String(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('subject_id', 'scope', 'revoked_at', name='uq_consents_active')
    )
    op.create_table('content_resources',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('source', sa.String(length=255), nullable=True),
    sa.Column('type', sa.String(length=50), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('metadata', sa.JSON(), nullable=True),
    sa.Column('mime_type', sa.String(length=100), nullable=True),
    sa.Column('storage_backend', sa.String(length=50), nullable=False),
    sa.Column('object_storage_key', sa.String(length=255), nullable=True),
    sa.Column('object_storage_bucket', sa.String(length=255), nullable=True),
    sa.Column('embedding_status', sa.String(length=50), nullable=False),
    sa.Column('embedding_last_processed_at', sa.DateTime(), nullable=True),
    sa.Column('chunk_count', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_content_resources_id'), 'content_resources', ['id'], unique=False)
    op.create_table('events',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('user_hash', sa.String(), nullable=False),
    sa.Column('session_id', sa.String(), nullable=True),
    sa.Column('agent', sa.Enum('STA', 'TCA', 'CMA', 'IA', name='agent_name_enum'), nullable=False),
    sa.Column('intent', sa.String(), nullable=True),
    sa.Column('risk_flag', sa.SmallInteger(), nullable=True),
    sa.Column('step', sa.String(), nullable=False),
    sa.Column('resource_id', sa.String(), nullable=True),
    sa.Column('latency_ms', sa.Integer(), nullable=True),
    sa.Column('tokens_in', sa.Integer(), nullable=True),
    sa.Column('tokens_out', sa.Integer(), nullable=True),
    sa.Column('cost_cents', sa.Integer(), nullable=True),
    sa.Column('outcome', sa.String(), nullable=True),
    sa.Column('consent_scope', sa.String(), nullable=True),
    sa.CheckConstraint('risk_flag >= 0 AND risk_flag <= 3', name='events_risk_flag_range'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_events_agent_created_at', 'events', ['agent', 'created_at'], unique=False)
    op.create_index(op.f('ix_events_created_at'), 'events', ['created_at'], unique=False)
    op.create_index('ix_events_intent_created_at', 'events', ['intent', 'created_at'], unique=False)
    op.create_index('ix_events_risk_flag_created_at', 'events', ['risk_flag', 'created_at'], unique=False)
    op.create_index(op.f('ix_events_user_hash'), 'events', ['user_hash'], unique=False)
    op.create_table('insights_reports',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('report_type', sa.String(length=50), nullable=False),
    sa.Column('period_start', sa.DateTime(timezone=True), nullable=False),
    sa.Column('period_end', sa.DateTime(timezone=True), nullable=False),
    sa.Column('summary', sa.Text(), nullable=True),
    sa.Column('trending_topics', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('sentiment_data', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('high_risk_count', sa.Integer(), nullable=False),
    sa.Column('assessment_count', sa.Integer(), nullable=False),
    sa.Column('generated_at', sa.DateTime(timezone=True), nullable=False),
    sa.Column('generated_by', sa.String(length=100), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_insights_reports_generated_at'), 'insights_reports', ['generated_at'], unique=False)
    op.create_index(op.f('ix_insights_reports_report_type'), 'insights_reports', ['report_type'], unique=False)
    op.create_table('intervention_campaigns',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('campaign_type', sa.String(length=100), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('content', sa.JSON(), nullable=False),
    sa.Column('target_criteria', sa.JSON(), nullable=True),
    sa.Column('target_audience_size', sa.Integer(), nullable=False),
    sa.Column('priority', sa.String(length=50), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('start_date', sa.DateTime(), nullable=False),
    sa.Column('end_date', sa.DateTime(), nullable=True),
    sa.Column('executions_delivered', sa.Integer(), nullable=False),
    sa.Column('executions_failed', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_intervention_campaigns_id'), 'intervention_campaigns', ['id'], unique=False)
    op.create_index(op.f('ix_intervention_campaigns_status'), 'intervention_campaigns', ['status'], unique=False)
    op.create_table('journal_prompts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('category', sa.String(), nullable=True),
    sa.Column('text', sa.Text(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_journal_prompts_category'), 'journal_prompts', ['category'], unique=False)
    op.create_index(op.f('ix_journal_prompts_id'), 'journal_prompts', ['id'], unique=False)
    op.create_table('messages',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('session_id', sa.String(), nullable=False),
    sa.Column('role', sa.Enum('user', 'assistant', 'system', name='message_role_enum'), nullable=False),
    sa.Column('content_redacted', sa.Text(), nullable=False),
    sa.Column('tools_used', postgresql.JSONB(astext_type=sa.Text()).with_variant(sa.JSON(), 'sqlite'), nullable=True),
    sa.Column('trace_id', sa.String(), nullable=True),
    sa.Column('ts', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_messages_session_id'), 'messages', ['session_id'], unique=False)
    op.create_index('ix_messages_tools_used', 'messages', ['tools_used'], unique=False, postgresql_using='gin')
    op.create_index(op.f('ix_messages_ts'), 'messages', ['ts'], unique=False)
    op.create_table('partner_transactions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('partner_name', sa.String(length=255), nullable=False),
    sa.Column('partner_type', sa.String(length=50), nullable=False),
    sa.Column('fee_amount', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('currency', sa.String(length=10), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED', 'CANCELLED', name='transactionstatus'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('external_transaction_id', sa.String(length=255), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_partner_transactions_created_at'), 'partner_transactions', ['created_at'], unique=False)
    op.create_index(op.f('ix_partner_transactions_id'), 'partner_transactions', ['id'], unique=False)
    op.create_index(op.f('ix_partner_transactions_status'), 'partner_transactions', ['status'], unique=False)
    op.create_table('quest_templates',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('code', sa.String(length=64), nullable=False),
    sa.Column('name', sa.String(length=120), nullable=False),
    sa.Column('short_description', sa.String(length=255), nullable=False),
    sa.Column('long_description', sa.Text(), nullable=True),
    sa.Column('category', sa.Enum('wellness', 'reflection', 'social', 'support', 'learning', name='questcategoryenum'), nullable=False),
    sa.Column('difficulty', sa.Enum('easy', 'standard', 'challenge', name='questdifficultyenum'), nullable=False),
    sa.Column('recommended_duration_minutes', sa.Integer(), nullable=False),
    sa.Column('base_xp', sa.Integer(), nullable=False),
    sa.Column('base_joy', sa.Integer(), nullable=False),
    sa.Column('base_harmony', sa.Integer(), nullable=False),
    sa.Column('extra_data', sa.JSON(), nullable=False),
    sa.Column('requires_counselor', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('code', name='uq_quest_templates_code')
    )
    op.create_table('resources',
    sa.Column('resource_id', sa.String(), nullable=False),
    sa.Column('title', sa.String(), nullable=False),
    sa.Column('category', sa.String(), nullable=True),
    sa.Column('eligibility', postgresql.JSONB(astext_type=sa.Text()).with_variant(sa.JSON(), 'sqlite'), nullable=True),
    sa.Column('contact', postgresql.JSONB(astext_type=sa.Text()).with_variant(sa.JSON(), 'sqlite'), nullable=True),
    sa.Column('url', sa.String(), nullable=True),
    sa.Column('active', sa.Boolean(), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), nullable=False),
    sa.PrimaryKeyConstraint('resource_id')
    )
    op.create_table('revenue_reports',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('year', sa.Integer(), nullable=False),
    sa.Column('month', sa.Integer(), nullable=False),
    sa.Column('month_yyyymm', sa.Integer(), nullable=False),
    sa.Column('wellness_fees', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('subscriptions', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('nft_sales', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('partner_fees', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('treasury_returns', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('total_revenue', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('total_expenses', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('net_profit', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('submitted_to_blockchain', sa.Boolean(), nullable=False),
    sa.Column('transaction_hash', sa.String(length=66), nullable=True),
    sa.Column('block_number', sa.Integer(), nullable=True),
    sa.Column('submission_timestamp', sa.DateTime(timezone=True), nullable=True),
    sa.Column('approvals_count', sa.Integer(), nullable=False),
    sa.Column('required_approvals', sa.Integer(), nullable=False),
    sa.Column('finalized', sa.Boolean(), nullable=False),
    sa.Column('finalized_timestamp', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.Enum('DRAFT', 'PENDING', 'APPROVED', 'SUBMITTED', 'FINALIZED', 'REJECTED', name='reportstatus'), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('created_by', sa.Integer(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_revenue_reports_id'), 'revenue_reports', ['id'], unique=False)
    op.create_index(op.f('ix_revenue_reports_month'), 'revenue_reports', ['month'], unique=False)
    op.create_index(op.f('ix_revenue_reports_month_yyyymm'), 'revenue_reports', ['month_yyyymm'], unique=True)
    op.create_index(op.f('ix_revenue_reports_transaction_hash'), 'revenue_reports', ['transaction_hash'], unique=False)
    op.create_index(op.f('ix_revenue_reports_year'), 'revenue_reports', ['year'], unique=False)
    op.create_table('surveys',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('category', sa.String(length=100), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_surveys_id'), 'surveys', ['id'], unique=False)
    op.create_table('tweets',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('tweet_id', sa.String(length=255), nullable=False),
    sa.Column('text', sa.String(), nullable=False),
    sa.Column('sentiment_score', sa.Float(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_tweets_id'), 'tweets', ['id'], unique=False)
    op.create_index(op.f('ix_tweets_tweet_id'), 'tweets', ['tweet_id'], unique=True)
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('google_sub', sa.String(), nullable=True),
    sa.Column('twitter_id', sa.String(), nullable=True),
    sa.Column('email', sa.String(), nullable=False),
    sa.Column('name', sa.String(), nullable=True),
    sa.Column('first_name', sa.String(), nullable=True),
    sa.Column('last_name', sa.String(), nullable=True),
    sa.Column('phone', sa.String(), nullable=True),
    sa.Column('date_of_birth', sa.Date(), nullable=True),
    sa.Column('gender', sa.String(), nullable=True),
    sa.Column('city', sa.String(), nullable=True),
    sa.Column('university', sa.String(), nullable=True),
    sa.Column('major', sa.String(), nullable=True),
    sa.Column('year_of_study', sa.String(), nullable=True),
    sa.Column('sentiment_score', sa.Float(), nullable=False),
    sa.Column('wallet_address', sa.String(), nullable=True),
    sa.Column('role', sa.String(), nullable=False),
    sa.Column('password_hash', sa.String(), nullable=True),
    sa.Column('password_reset_token', sa.String(), nullable=True),
    sa.Column('password_reset_expires', sa.DateTime(), nullable=True),
    sa.Column('email_verified', sa.Boolean(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.Column('last_login', sa.DateTime(), nullable=True),
    sa.Column('current_streak', sa.Integer(), nullable=False),
    sa.Column('longest_streak', sa.Integer(), nullable=False),
    sa.Column('last_activity_date', sa.Date(), nullable=True),
    sa.Column('allow_email_checkins', sa.Boolean(), nullable=False),
    sa.Column('profile_photo_url', sa.String(), nullable=True),
    sa.Column('preferred_name', sa.String(), nullable=True),
    sa.Column('pronouns', sa.String(), nullable=True),
    sa.Column('alternate_phone', sa.String(), nullable=True),
    sa.Column('check_in_code', sa.String(length=64), nullable=True),
    sa.Column('emergency_contact_name', sa.String(), nullable=True),
    sa.Column('emergency_contact_relationship', sa.String(), nullable=True),
    sa.Column('emergency_contact_phone', sa.String(), nullable=True),
    sa.Column('emergency_contact_email', sa.String(), nullable=True),
    sa.Column('risk_level', sa.String(), nullable=True),
    sa.Column('clinical_summary', sa.Text(), nullable=True),
    sa.Column('primary_concerns', sa.Text(), nullable=True),
    sa.Column('safety_plan_notes', sa.Text(), nullable=True),
    sa.Column('current_therapist_name', sa.String(), nullable=True),
    sa.Column('current_therapist_contact', sa.String(), nullable=True),
    sa.Column('therapy_modality', sa.String(), nullable=True),
    sa.Column('therapy_frequency', sa.String(), nullable=True),
    sa.Column('therapy_notes', sa.Text(), nullable=True),
    sa.Column('consent_data_sharing', sa.Boolean(), nullable=False),
    sa.Column('consent_research', sa.Boolean(), nullable=False),
    sa.Column('consent_emergency_contact', sa.Boolean(), nullable=False),
    sa.Column('consent_marketing', sa.Boolean(), nullable=False),
    sa.Column('preferred_language', sa.String(), nullable=True),
    sa.Column('preferred_timezone', sa.String(), nullable=True),
    sa.Column('accessibility_needs', sa.Text(), nullable=True),
    sa.Column('communication_preferences', sa.Text(), nullable=True),
    sa.Column('interface_preferences', sa.Text(), nullable=True),
    sa.Column('aicare_team_notes', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('check_in_code')
    )
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_google_sub'), 'users', ['google_sub'], unique=True)
    op.create_index(op.f('ix_users_id'), 'users', ['id'], unique=False)
    op.create_index(op.f('ix_users_twitter_id'), 'users', ['twitter_id'], unique=True)
    op.create_index(op.f('ix_users_wallet_address'), 'users', ['wallet_address'], unique=True)
    op.create_table('agent_runs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('agent_name', sa.String(length=64), nullable=False),
    sa.Column('action', sa.String(length=64), nullable=False),
    sa.Column('status', sa.String(length=32), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('input_payload', sa.JSON(), nullable=True),
    sa.Column('output_payload', sa.JSON(), nullable=True),
    sa.Column('correlation_id', sa.String(length=128), nullable=False),
    sa.Column('triggered_by_user_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['triggered_by_user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_agent_runs_action'), 'agent_runs', ['action'], unique=False)
    op.create_index(op.f('ix_agent_runs_agent_name'), 'agent_runs', ['agent_name'], unique=False)
    op.create_index(op.f('ix_agent_runs_correlation_id'), 'agent_runs', ['correlation_id'], unique=False)
    op.create_index(op.f('ix_agent_runs_id'), 'agent_runs', ['id'], unique=False)
    op.create_index(op.f('ix_agent_runs_status'), 'agent_runs', ['status'], unique=False)
    op.create_index(op.f('ix_agent_runs_triggered_by_user_id'), 'agent_runs', ['triggered_by_user_id'], unique=False)
    op.create_table('campaign_executions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('campaign_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('scheduled_at', sa.DateTime(), nullable=False),
    sa.Column('executed_at', sa.DateTime(), nullable=True),
    sa.Column('delivery_method', sa.String(length=100), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('engagement_score', sa.Float(), nullable=True),
    sa.Column('trigger_data', sa.JSON(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('is_manual', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['campaign_id'], ['intervention_campaigns.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_campaign_executions_campaign_id'), 'campaign_executions', ['campaign_id'], unique=False)
    op.create_index(op.f('ix_campaign_executions_id'), 'campaign_executions', ['id'], unique=False)
    op.create_index(op.f('ix_campaign_executions_status'), 'campaign_executions', ['status'], unique=False)
    op.create_index(op.f('ix_campaign_executions_user_id'), 'campaign_executions', ['user_id'], unique=False)
    op.create_table('campaigns',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('trigger_rules', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('message_template', sa.Text(), nullable=False),
    sa.Column('target_audience', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('priority', sa.String(length=50), nullable=False),
    sa.Column('created_by', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default='now()', nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default='now()', nullable=False),
    sa.Column('last_executed_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['created_by'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_campaigns_status'), 'campaigns', ['status'], unique=False)
    op.create_table('cbt_module_steps',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('module_id', sa.Integer(), nullable=False),
    sa.Column('step_order', sa.Integer(), nullable=False),
    sa.Column('step_type', sa.String(length=50), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('user_input_type', sa.String(length=50), nullable=True),
    sa.Column('user_input_variable', sa.String(length=100), nullable=True),
    sa.Column('feedback_prompt', sa.Text(), nullable=True),
    sa.Column('options', sa.JSON(), nullable=True),
    sa.Column('tool_to_run', sa.String(length=100), nullable=True),
    sa.Column('is_skippable', sa.Boolean(), nullable=False),
    sa.Column('delay_after_ms', sa.Integer(), nullable=False),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['module_id'], ['cbt_modules.id'], ),
    sa.ForeignKeyConstraint(['parent_id'], ['cbt_module_steps.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_cbt_module_steps_id'), 'cbt_module_steps', ['id'], unique=False)
    op.create_table('compliance_audit_log',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('actor_id', sa.Integer(), nullable=True),
    sa.Column('actor_role', sa.String(length=64), nullable=True),
    sa.Column('action', sa.String(length=120), nullable=False),
    sa.Column('entity_type', sa.String(length=120), nullable=True),
    sa.Column('entity_id', sa.String(length=120), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['actor_id'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_table('conversation_risk_assessments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('conversation_id', sa.String(length=255), nullable=True),
    sa.Column('session_id', sa.String(length=255), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('overall_risk_level', sa.String(length=32), nullable=False),
    sa.Column('risk_trend', sa.String(length=32), nullable=False),
    sa.Column('conversation_summary', sa.Text(), nullable=False),
    sa.Column('user_context', sa.JSON(), nullable=True),
    sa.Column('protective_factors', sa.JSON(), nullable=True),
    sa.Column('concerns', sa.JSON(), nullable=True),
    sa.Column('recommended_actions', sa.JSON(), nullable=True),
    sa.Column('should_invoke_cma', sa.Boolean(), nullable=False),
    sa.Column('reasoning', sa.Text(), nullable=False),
    sa.Column('message_count', sa.Integer(), nullable=False),
    sa.Column('conversation_duration_seconds', sa.Float(), nullable=True),
    sa.Column('analysis_timestamp', sa.DateTime(), nullable=False),
    sa.Column('raw_assessment', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_conversation_risk_assessments_conversation_id'), 'conversation_risk_assessments', ['conversation_id'], unique=False)
    op.create_index(op.f('ix_conversation_risk_assessments_id'), 'conversation_risk_assessments', ['id'], unique=False)
    op.create_index(op.f('ix_conversation_risk_assessments_session_id'), 'conversation_risk_assessments', ['session_id'], unique=False)
    op.create_index(op.f('ix_conversation_risk_assessments_user_id'), 'conversation_risk_assessments', ['user_id'], unique=False)
    op.create_table('conversations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.String(), nullable=False),
    sa.Column('conversation_id', sa.String(), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('response', sa.Text(), nullable=False),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_conversations_conversation_id'), 'conversations', ['conversation_id'], unique=False)
    op.create_index(op.f('ix_conversations_id'), 'conversations', ['id'], unique=False)
    op.create_index(op.f('ix_conversations_session_id'), 'conversations', ['session_id'], unique=False)
    op.create_table('feedback',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('session_id', sa.String(), nullable=True),
    sa.Column('ease_of_use_rating', sa.Integer(), nullable=True),
    sa.Column('chatbot_understanding_rating', sa.Integer(), nullable=True),
    sa.Column('felt_understood_rating', sa.Integer(), nullable=True),
    sa.Column('nps_rating', sa.Integer(), nullable=True),
    sa.Column('goal_achieved', sa.String(), nullable=True),
    sa.Column('improvement_suggestion', sa.Text(), nullable=False),
    sa.Column('category', sa.String(), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_feedback_id'), 'feedback', ['id'], unique=False)
    op.create_index(op.f('ix_feedback_session_id'), 'feedback', ['session_id'], unique=False)
    op.create_index(op.f('ix_feedback_user_id'), 'feedback', ['user_id'], unique=False)
    op.create_table('flagged_sessions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.String(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('reason', sa.Text(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('flagged_by_admin_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['flagged_by_admin_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_flagged_sessions_flagged_by_admin_id'), 'flagged_sessions', ['flagged_by_admin_id'], unique=False)
    op.create_index(op.f('ix_flagged_sessions_id'), 'flagged_sessions', ['id'], unique=False)
    op.create_index(op.f('ix_flagged_sessions_session_id'), 'flagged_sessions', ['session_id'], unique=False)
    op.create_index(op.f('ix_flagged_sessions_status'), 'flagged_sessions', ['status'], unique=False)
    op.create_index(op.f('ix_flagged_sessions_user_id'), 'flagged_sessions', ['user_id'], unique=False)
    op.create_table('journal_entries',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('entry_date', sa.Date(), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('prompt_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['prompt_id'], ['journal_prompts.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('user_id', 'entry_date', name='_user_entry_date_uc')
    )
    op.create_index(op.f('ix_journal_entries_entry_date'), 'journal_entries', ['entry_date'], unique=False)
    op.create_index(op.f('ix_journal_entries_id'), 'journal_entries', ['id'], unique=False)
    op.create_index(op.f('ix_journal_entries_user_id'), 'journal_entries', ['user_id'], unique=False)
    op.create_table('nft_transactions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('nft_contract_address', sa.String(length=42), nullable=False),
    sa.Column('token_id', sa.String(length=100), nullable=False),
    sa.Column('nft_name', sa.String(length=255), nullable=False),
    sa.Column('price', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('currency', sa.String(length=10), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED', 'CANCELLED', name='transactionstatus'), nullable=False),
    sa.Column('blockchain_tx_hash', sa.String(length=66), nullable=True),
    sa.Column('block_number', sa.Integer(), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_nft_transactions_created_at'), 'nft_transactions', ['created_at'], unique=False)
    op.create_index(op.f('ix_nft_transactions_id'), 'nft_transactions', ['id'], unique=False)
    op.create_index(op.f('ix_nft_transactions_status'), 'nft_transactions', ['status'], unique=False)
    op.create_index(op.f('ix_nft_transactions_user_id'), 'nft_transactions', ['user_id'], unique=False)
    op.create_table('player_wellness_state',
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('current_streak', sa.Integer(), nullable=False),
    sa.Column('longest_streak', sa.Integer(), nullable=False),
    sa.Column('compassion_mode_active', sa.Boolean(), nullable=False),
    sa.Column('compassion_activated_at', sa.DateTime(), nullable=True),
    sa.Column('last_completed_at', sa.DateTime(), nullable=True),
    sa.Column('harmony_score', sa.Float(), nullable=False),
    sa.Column('joy_balance', sa.Float(), nullable=False),
    sa.Column('extra_data', sa.JSON(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('user_id')
    )
    op.create_table('psychologists',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('specialization', sa.String(), nullable=True),
    sa.Column('image_url', sa.String(), nullable=True),
    sa.Column('is_available', sa.Boolean(), nullable=False),
    sa.Column('bio', sa.Text(), nullable=True),
    sa.Column('education', sa.JSON(), nullable=True),
    sa.Column('certifications', sa.JSON(), nullable=True),
    sa.Column('years_of_experience', sa.Integer(), nullable=True),
    sa.Column('languages', sa.JSON(), nullable=True),
    sa.Column('consultation_fee', sa.Float(), nullable=True),
    sa.Column('availability_schedule', sa.JSON(), nullable=True),
    sa.Column('rating', sa.Float(), nullable=True),
    sa.Column('total_reviews', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_psychologists_id'), 'psychologists', ['id'], unique=False)
    op.create_index(op.f('ix_psychologists_is_available'), 'psychologists', ['is_available'], unique=False)
    op.create_index(op.f('ix_psychologists_user_id'), 'psychologists', ['user_id'], unique=True)
    op.create_table('quest_instances',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('template_id', sa.Integer(), nullable=False),
    sa.Column('status', sa.Enum('active', 'completed', 'expired', 'cancelled', name='queststatusenum'), nullable=False),
    sa.Column('issued_at', sa.DateTime(), nullable=False),
    sa.Column('expires_at', sa.DateTime(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('completion_payload', sa.JSON(), nullable=True),
    sa.Column('streak_snapshot', sa.Integer(), nullable=False),
    sa.Column('compassion_mode', sa.Boolean(), nullable=False),
    sa.ForeignKeyConstraint(['template_id'], ['quest_templates.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_quest_instances_expires_at', 'quest_instances', ['expires_at'], unique=False)
    op.create_index('ix_quest_instances_user_status', 'quest_instances', ['user_id', 'status'], unique=False)
    op.create_table('revenue_approvals',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('report_id', sa.Integer(), nullable=False),
    sa.Column('approver_address', sa.String(length=42), nullable=False),
    sa.Column('approver_name', sa.String(length=100), nullable=True),
    sa.Column('approved', sa.Boolean(), nullable=False),
    sa.Column('transaction_hash', sa.String(length=66), nullable=True),
    sa.Column('block_number', sa.Integer(), nullable=True),
    sa.Column('comment', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['report_id'], ['revenue_reports.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_revenue_approvals_id'), 'revenue_approvals', ['id'], unique=False)
    op.create_index(op.f('ix_revenue_approvals_report_id'), 'revenue_approvals', ['report_id'], unique=False)
    op.create_table('subscriptions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('plan_name', sa.String(length=100), nullable=False),
    sa.Column('amount', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('currency', sa.String(length=10), nullable=False),
    sa.Column('billing_date', sa.DateTime(timezone=True), nullable=False),
    sa.Column('next_billing_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('status', sa.Enum('ACTIVE', 'EXPIRED', 'CANCELLED', 'SUSPENDED', name='subscriptionstatus'), nullable=False),
    sa.Column('payment_method', sa.String(length=50), nullable=True),
    sa.Column('external_subscription_id', sa.String(length=255), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('cancelled_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_subscriptions_billing_date'), 'subscriptions', ['billing_date'], unique=False)
    op.create_index(op.f('ix_subscriptions_id'), 'subscriptions', ['id'], unique=False)
    op.create_index(op.f('ix_subscriptions_status'), 'subscriptions', ['status'], unique=False)
    op.create_index(op.f('ix_subscriptions_user_id'), 'subscriptions', ['user_id'], unique=False)
    op.create_table('survey_questions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('survey_id', sa.Integer(), nullable=False),
    sa.Column('question_text', sa.Text(), nullable=False),
    sa.Column('question_type', sa.String(), nullable=False),
    sa.Column('options', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['survey_id'], ['surveys.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_survey_questions_id'), 'survey_questions', ['id'], unique=False)
    op.create_table('survey_responses',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('survey_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['survey_id'], ['surveys.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_survey_responses_id'), 'survey_responses', ['id'], unique=False)
    op.create_table('system_settings',
    sa.Column('key', sa.String(length=255), nullable=False),
    sa.Column('value', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('category', sa.String(length=100), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('updated_by', sa.Integer(), nullable=True),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['updated_by'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('key')
    )
    op.create_index(op.f('ix_system_settings_category'), 'system_settings', ['category'], unique=False)
    op.create_table('therapist_schedules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('therapist_id', sa.Integer(), nullable=False),
    sa.Column('day_of_week', sa.String(), nullable=False),
    sa.Column('start_time', sa.String(), nullable=False),
    sa.Column('end_time', sa.String(), nullable=False),
    sa.Column('is_available', sa.Boolean(), nullable=False),
    sa.Column('reason', sa.String(), nullable=True),
    sa.ForeignKeyConstraint(['therapist_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_therapist_schedules_id'), 'therapist_schedules', ['id'], unique=False)
    op.create_table('transactions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('transaction_type', sa.Enum('WELLNESS_FEE', 'SUBSCRIPTION', 'NFT_SALE', 'PARTNER_FEE', 'TREASURY_RETURN', 'REFUND', 'ADJUSTMENT', name='transactiontype'), nullable=False),
    sa.Column('amount', sa.Numeric(precision=20, scale=6), nullable=False),
    sa.Column('currency', sa.String(length=10), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED', 'CANCELLED', name='transactionstatus'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('payment_method', sa.String(length=50), nullable=True),
    sa.Column('payment_gateway', sa.String(length=50), nullable=True),
    sa.Column('external_transaction_id', sa.String(length=255), nullable=True),
    sa.Column('blockchain_tx_hash', sa.String(length=66), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(timezone=True), nullable=True),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_transactions_created_at'), 'transactions', ['created_at'], unique=False)
    op.create_index(op.f('ix_transactions_id'), 'transactions', ['id'], unique=False)
    op.create_index(op.f('ix_transactions_status'), 'transactions', ['status'], unique=False)
    op.create_index(op.f('ix_transactions_transaction_type'), 'transactions', ['transaction_type'], unique=False)
    op.create_index(op.f('ix_transactions_user_id'), 'transactions', ['user_id'], unique=False)
    op.create_table('user_audit_log',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-many relationship)'),
    sa.Column('action', sa.String(length=50), nullable=False, comment="Action: 'created', 'updated', 'deleted', 'viewed', 'exported', 'migrated'"),
    sa.Column('table_name', sa.String(length=100), nullable=False, comment="Table that was changed (e.g., 'user_profiles', 'user_clinical_records')"),
    sa.Column('record_id', sa.Integer(), nullable=True, comment='ID of the specific record that was changed'),
    sa.Column('changed_fields', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment="Changed fields with old/new values: {'field': {'old': 'value1', 'new': 'value2'}}"),
    sa.Column('change_reason', sa.Text(), nullable=True, comment="Why the change was made (e.g., 'Risk escalation detected by STA', 'User profile update')"),
    sa.Column('changed_by_user_id', sa.Integer(), nullable=True, comment='User who made the change (NULL for system/agent changes)'),
    sa.Column('changed_by_role', sa.String(length=50), nullable=True, comment="Role of actor: 'user', 'counselor', 'admin', 'system', 'agent'"),
    sa.Column('changed_by_name', sa.String(length=200), nullable=True, comment='Name of actor (for human readability)'),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP address of request'),
    sa.Column('user_agent', sa.Text(), nullable=True, comment='Browser/app user agent string'),
    sa.Column('request_id', sa.String(length=100), nullable=True, comment='Distributed tracing request ID (for tracking across microservices)'),
    sa.Column('session_id', sa.String(length=100), nullable=True, comment='Session ID (for tracking user session)'),
    sa.Column('timestamp', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When the change occurred'),
    sa.ForeignKeyConstraint(['changed_by_user_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_audit_log_action'), 'user_audit_log', ['action'], unique=False)
    op.create_index(op.f('ix_user_audit_log_changed_by_user_id'), 'user_audit_log', ['changed_by_user_id'], unique=False)
    op.create_index(op.f('ix_user_audit_log_id'), 'user_audit_log', ['id'], unique=False)
    op.create_index(op.f('ix_user_audit_log_request_id'), 'user_audit_log', ['request_id'], unique=False)
    op.create_index(op.f('ix_user_audit_log_session_id'), 'user_audit_log', ['session_id'], unique=False)
    op.create_index(op.f('ix_user_audit_log_table_name'), 'user_audit_log', ['table_name'], unique=False)
    op.create_index(op.f('ix_user_audit_log_timestamp'), 'user_audit_log', ['timestamp'], unique=False)
    op.create_index(op.f('ix_user_audit_log_user_id'), 'user_audit_log', ['user_id'], unique=False)
    op.create_table('user_badges',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('badge_id', sa.Integer(), nullable=False),
    sa.Column('contract_address', sa.String(), nullable=False),
    sa.Column('transaction_hash', sa.String(), nullable=False),
    sa.Column('awarded_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('transaction_hash'),
    sa.UniqueConstraint('user_id', 'badge_id', name='_user_badge_uc')
    )
    op.create_index(op.f('ix_user_badges_badge_id'), 'user_badges', ['badge_id'], unique=False)
    op.create_index(op.f('ix_user_badges_contract_address'), 'user_badges', ['contract_address'], unique=False)
    op.create_index(op.f('ix_user_badges_id'), 'user_badges', ['id'], unique=False)
    op.create_index(op.f('ix_user_badges_user_id'), 'user_badges', ['user_id'], unique=False)
    op.create_table('user_clinical_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-one relationship)'),
    sa.Column('current_risk_level', sa.String(length=20), nullable=True, comment='Current risk level: low, medium, high, critical'),
    sa.Column('last_risk_assessment_date', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_risk_score', sa.Float(), nullable=True, comment='Numeric risk score (0.0-10.0) from STA agent'),
    sa.Column('highest_risk_level_ever', sa.String(length=20), nullable=True, comment='Historical peak risk level (for trend analysis)'),
    sa.Column('crisis_count', sa.Integer(), nullable=True, comment='Number of crisis episodes detected'),
    sa.Column('clinical_summary', sa.Text(), nullable=True, comment="Counselor's clinical summary (unlimited length)"),
    sa.Column('primary_concerns', sa.ARRAY(sa.String()), nullable=True, comment="Main mental health concerns (e.g., ['anxiety', 'depression'])"),
    sa.Column('diagnosed_conditions', sa.ARRAY(sa.String()), nullable=True, comment='Professionally diagnosed conditions (if any)'),
    sa.Column('symptom_onset_date', sa.Date(), nullable=True, comment='When symptoms first appeared'),
    sa.Column('safety_plan_active', sa.Boolean(), nullable=True, comment='Whether user has an active safety plan'),
    sa.Column('safety_plan_notes', sa.Text(), nullable=True),
    sa.Column('safety_plan_created_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('safety_plan_reviewed_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('safety_plan_reviewed_by_user_id', sa.Integer(), nullable=True, comment='Counselor who last reviewed the safety plan'),
    sa.Column('warning_signs', sa.ARRAY(sa.String()), nullable=True, comment="Early warning signs of crisis (e.g., ['isolation', 'sleep_disruption'])"),
    sa.Column('coping_strategies', sa.ARRAY(sa.String()), nullable=True, comment="Coping strategies for crisis (e.g., ['call_friend', 'breathing_exercise'])"),
    sa.Column('is_in_external_therapy', sa.Boolean(), nullable=True, comment='Whether user is seeing an external therapist'),
    sa.Column('external_therapist_name', sa.String(length=200), nullable=True),
    sa.Column('external_therapist_contact', sa.String(length=100), nullable=True),
    sa.Column('external_therapist_institution', sa.String(length=200), nullable=True),
    sa.Column('therapy_modality', sa.String(length=100), nullable=True, comment="Type of therapy (e.g., 'CBT', 'DBT', 'Psychodynamic')"),
    sa.Column('therapy_frequency', sa.String(length=100), nullable=True, comment="e.g., 'weekly', 'biweekly', 'monthly'"),
    sa.Column('therapy_start_date', sa.Date(), nullable=True),
    sa.Column('therapy_end_date', sa.Date(), nullable=True),
    sa.Column('is_on_medication', sa.Boolean(), nullable=True, comment='Whether user is taking psychiatric medication'),
    sa.Column('medication_notes', sa.Text(), nullable=True, comment='Medication details (not prescriptions - reference only)'),
    sa.Column('medication_start_date', sa.Date(), nullable=True),
    sa.Column('prescribing_doctor', sa.String(length=200), nullable=True),
    sa.Column('aicare_team_notes', sa.Text(), nullable=True, comment='Internal notes from UGM-AICare team (not visible to user)'),
    sa.Column('flagged_for_review', sa.Boolean(), nullable=True, comment='Flagged by agent for counselor review'),
    sa.Column('flagged_reason', sa.Text(), nullable=True),
    sa.Column('flagged_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('flagged_by_user_id', sa.Integer(), nullable=True, comment='Agent/counselor who flagged this case'),
    sa.Column('access_level', sa.String(length=50), nullable=True, comment='counselor_only | clinical_team | research_anonymized'),
    sa.Column('data_sharing_restrictions', sa.Text(), nullable=True, comment="Special restrictions on data sharing (e.g., 'Do not share with external research')"),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_by_user_id', sa.Integer(), nullable=True, comment='Last counselor/admin who edited this record'),
    sa.Column('last_reviewed_at', sa.DateTime(timezone=True), nullable=True, comment='Last clinical review date (for SLA tracking)'),
    sa.Column('last_reviewed_by_user_id', sa.Integer(), nullable=True, comment='Counselor who performed last review'),
    sa.ForeignKeyConstraint(['flagged_by_user_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['last_reviewed_by_user_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['safety_plan_reviewed_by_user_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['updated_by_user_id'], ['users.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_clinical_records_current_risk_level'), 'user_clinical_records', ['current_risk_level'], unique=False)
    op.create_index(op.f('ix_user_clinical_records_flagged_for_review'), 'user_clinical_records', ['flagged_for_review'], unique=False)
    op.create_index(op.f('ix_user_clinical_records_id'), 'user_clinical_records', ['id'], unique=False)
    op.create_index(op.f('ix_user_clinical_records_last_risk_assessment_date'), 'user_clinical_records', ['last_risk_assessment_date'], unique=False)
    op.create_index(op.f('ix_user_clinical_records_user_id'), 'user_clinical_records', ['user_id'], unique=True)
    op.create_table('user_consent_ledger',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-many relationship)'),
    sa.Column('consent_type', sa.String(length=100), nullable=False, comment="Type: 'data_sharing', 'research', 'marketing', 'emergency_contact', 'analytics', 'ai_coaching'"),
    sa.Column('granted', sa.Boolean(), nullable=False, comment='True=consent granted, False=consent withdrawn'),
    sa.Column('scope', sa.Text(), nullable=True, comment="Scope of consent (e.g., 'Share anonymized mood data with research team')"),
    sa.Column('consent_version', sa.String(length=50), nullable=False, comment="Version of consent document (e.g., 'v1.0', 'v2.1')"),
    sa.Column('consent_document_url', sa.String(length=500), nullable=True, comment='URL to the consent document user agreed to'),
    sa.Column('consent_language', sa.String(length=10), nullable=True, comment="Language consent was shown in (e.g., 'id', 'en')"),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP address where consent was given'),
    sa.Column('user_agent', sa.Text(), nullable=True, comment='Browser/app user agent string'),
    sa.Column('device_type', sa.String(length=50), nullable=True, comment="Device type: 'mobile', 'tablet', 'desktop'"),
    sa.Column('consent_method', sa.String(length=50), nullable=True, comment="Method: 'checkbox', 'digital_signature', 'verbal_recorded', 'opt_in', 'opt_out'"),
    sa.Column('timestamp', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When consent was granted/withdrawn'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=True, comment='When consent expires (optional, for time-limited consent)'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_consent_ledger_consent_type'), 'user_consent_ledger', ['consent_type'], unique=False)
    op.create_index(op.f('ix_user_consent_ledger_granted'), 'user_consent_ledger', ['granted'], unique=False)
    op.create_index(op.f('ix_user_consent_ledger_id'), 'user_consent_ledger', ['id'], unique=False)
    op.create_index(op.f('ix_user_consent_ledger_timestamp'), 'user_consent_ledger', ['timestamp'], unique=False)
    op.create_index(op.f('ix_user_consent_ledger_user_id'), 'user_consent_ledger', ['user_id'], unique=False)
    op.create_table('user_emergency_contacts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-many relationship)'),
    sa.Column('full_name', sa.String(length=200), nullable=False, comment='Full name of emergency contact'),
    sa.Column('relationship_to_user', sa.String(length=100), nullable=False, comment="Relationship to user (e.g., 'Mother', 'Best Friend', 'Academic Advisor')"),
    sa.Column('phone', sa.String(length=20), nullable=False, comment='Primary phone number'),
    sa.Column('alternate_phone', sa.String(length=20), nullable=True, comment='Alternate phone number (optional)'),
    sa.Column('email', sa.String(length=255), nullable=True, comment='Email address (optional)'),
    sa.Column('address', sa.Text(), nullable=True, comment='Full address (for in-person contact if needed)'),
    sa.Column('priority', sa.Integer(), nullable=False, comment='Contact priority: 1=primary, 2=secondary, 3=tertiary, etc.'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Whether this contact is currently active'),
    sa.Column('can_receive_crisis_alerts', sa.Boolean(), nullable=True, comment='Whether to notify during crisis (some contacts prefer no alerts)'),
    sa.Column('contact_time_restrictions', sa.Text(), nullable=True, comment="Time restrictions (e.g., 'Only 9am-5pm weekdays', 'No late night calls')"),
    sa.Column('consent_to_contact', sa.Boolean(), nullable=False, comment='Contact has consented to be emergency contact'),
    sa.Column('consent_granted_date', sa.Date(), nullable=True, comment='When consent was granted'),
    sa.Column('consent_expires_date', sa.Date(), nullable=True, comment='When consent expires (optional, for time-limited consent)'),
    sa.Column('consent_method', sa.String(length=50), nullable=True, comment="How consent was obtained: 'verbal', 'written', 'digital_signature'"),
    sa.Column('notes', sa.Text(), nullable=True, comment="Additional notes about this contact (e.g., 'Speaks English only', 'Prefers WhatsApp')"),
    sa.Column('last_contacted_at', sa.DateTime(timezone=True), nullable=True, comment='When this contact was last reached (for audit and avoiding over-contact)'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_emergency_contacts_id'), 'user_emergency_contacts', ['id'], unique=False)
    op.create_index(op.f('ix_user_emergency_contacts_is_active'), 'user_emergency_contacts', ['is_active'], unique=False)
    op.create_index(op.f('ix_user_emergency_contacts_priority'), 'user_emergency_contacts', ['priority'], unique=False)
    op.create_index(op.f('ix_user_emergency_contacts_user_id'), 'user_emergency_contacts', ['user_id'], unique=False)
    op.create_table('user_preferences',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-one relationship)'),
    sa.Column('preferred_language', sa.String(length=10), nullable=True, comment="ISO 639-1 code: 'id' (Indonesian), 'en' (English), 'jv' (Javanese)"),
    sa.Column('preferred_timezone', sa.String(length=50), nullable=True, comment="IANA timezone (e.g., 'Asia/Jakarta', 'Asia/Makassar')"),
    sa.Column('date_format', sa.String(length=20), nullable=True, comment='Date display format'),
    sa.Column('time_format', sa.String(length=10), nullable=True, comment='12h or 24h'),
    sa.Column('allow_email_checkins', sa.Boolean(), nullable=True),
    sa.Column('allow_sms_reminders', sa.Boolean(), nullable=True),
    sa.Column('allow_push_notifications', sa.Boolean(), nullable=True),
    sa.Column('allow_whatsapp_notifications', sa.Boolean(), nullable=True, comment='WhatsApp is very popular in Indonesia'),
    sa.Column('notification_quiet_hours_start', sa.Time(), nullable=True),
    sa.Column('notification_quiet_hours_end', sa.Time(), nullable=True),
    sa.Column('notification_frequency', sa.String(length=20), nullable=True, comment='low | normal | high'),
    sa.Column('email_frequency', sa.String(length=20), nullable=True, comment='daily | weekly | monthly | never'),
    sa.Column('email_newsletter', sa.Boolean(), nullable=True, comment='Subscribe to UGM-AICare newsletter'),
    sa.Column('email_updates', sa.Boolean(), nullable=True, comment='Receive platform updates & announcements'),
    sa.Column('theme', sa.String(length=20), nullable=True, comment='light | dark | system'),
    sa.Column('font_size', sa.String(length=20), nullable=True, comment='small | medium | large | xlarge'),
    sa.Column('high_contrast_mode', sa.Boolean(), nullable=True, comment='High contrast for visual impairment'),
    sa.Column('reduce_animations', sa.Boolean(), nullable=True, comment='Reduce motion for vestibular disorders'),
    sa.Column('color_scheme', sa.String(length=50), nullable=True, comment='Custom color scheme (future feature)'),
    sa.Column('screen_reader_enabled', sa.Boolean(), nullable=True, comment='Using screen reader (optimize for ARIA)'),
    sa.Column('keyboard_navigation_only', sa.Boolean(), nullable=True, comment='Navigate without mouse (motor impairment)'),
    sa.Column('dyslexia_font', sa.Boolean(), nullable=True, comment='Use dyslexia-friendly font (OpenDyslexic)'),
    sa.Column('accessibility_notes', sa.Text(), nullable=True, comment='Additional accessibility needs (free text)'),
    sa.Column('check_in_code', sa.String(length=50), nullable=True, comment="Unique code for daily check-ins (e.g., 'MOOD-abc123')"),
    sa.Column('check_in_frequency', sa.String(length=20), nullable=True, comment='daily | weekly | manual'),
    sa.Column('check_in_reminder_time', sa.Time(), nullable=True, comment="Preferred time for daily check-in reminder (e.g., '09:00')"),
    sa.Column('check_in_reminder_enabled', sa.Boolean(), nullable=True),
    sa.Column('profile_visibility', sa.String(length=20), nullable=True, comment='public | friends | private'),
    sa.Column('show_online_status', sa.Boolean(), nullable=True, comment='Show when user is online (future social feature)'),
    sa.Column('allow_analytics_tracking', sa.Boolean(), nullable=True, comment='Consent to anonymized analytics (IA agent)'),
    sa.Column('aika_personality', sa.String(length=20), nullable=True, comment='empathetic | professional | casual | balanced'),
    sa.Column('aika_response_length', sa.String(length=20), nullable=True, comment='concise | balanced | detailed'),
    sa.Column('auto_suggest_interventions', sa.Boolean(), nullable=True, comment='Aika proactively suggests CBT interventions'),
    sa.Column('created_at', sa.Integer(), server_default=sa.text('EXTRACT(epoch FROM now())'), nullable=False),
    sa.Column('updated_at', sa.Integer(), server_default=sa.text('EXTRACT(epoch FROM now())'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_preferences_check_in_code'), 'user_preferences', ['check_in_code'], unique=True)
    op.create_index(op.f('ix_user_preferences_id'), 'user_preferences', ['id'], unique=False)
    op.create_index(op.f('ix_user_preferences_user_id'), 'user_preferences', ['user_id'], unique=True)
    op.create_table('user_profiles',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-one relationship)'),
    sa.Column('first_name', sa.String(length=100), nullable=True, comment="Given name (e.g., 'John')"),
    sa.Column('last_name', sa.String(length=100), nullable=True, comment="Family name (e.g., 'Doe')"),
    sa.Column('preferred_name', sa.String(length=100), nullable=True, comment="What they want to be called (e.g., 'Johnny')"),
    sa.Column('pronouns', sa.String(length=50), nullable=True, comment="e.g., 'he/him', 'she/her', 'they/them'"),
    sa.Column('phone', sa.String(length=20), nullable=True),
    sa.Column('alternate_phone', sa.String(length=20), nullable=True),
    sa.Column('date_of_birth', sa.Date(), nullable=True),
    sa.Column('gender', sa.String(length=50), nullable=True),
    sa.Column('city', sa.String(length=100), nullable=True),
    sa.Column('province', sa.String(length=100), nullable=True, comment="Indonesian province (e.g., 'DI Yogyakarta')"),
    sa.Column('country', sa.String(length=100), nullable=True, comment='Country of residence'),
    sa.Column('university', sa.String(length=200), nullable=True),
    sa.Column('faculty', sa.String(length=200), nullable=True, comment="UGM faculty (e.g., 'FMIPA', 'FEB', 'FK')"),
    sa.Column('department', sa.String(length=200), nullable=True, comment="Department/Program (e.g., 'Computer Science')"),
    sa.Column('major', sa.String(length=200), nullable=True),
    sa.Column('year_of_study', sa.Integer(), nullable=True),
    sa.Column('student_id', sa.String(length=50), nullable=True, comment='Official NIM (Nomor Induk Mahasiswa) - UNIQUE identifier'),
    sa.Column('batch_year', sa.Integer(), nullable=True, comment='Enrollment year (e.g., 2021)'),
    sa.Column('profile_photo_url', sa.String(length=500), nullable=True),
    sa.Column('profile_photo_storage_key', sa.String(length=200), nullable=True, comment='S3/MinIO storage key for profile photo'),
    sa.Column('current_streak', sa.Integer(), nullable=True),
    sa.Column('longest_streak', sa.Integer(), nullable=True),
    sa.Column('last_activity_date', sa.Date(), nullable=True),
    sa.Column('sentiment_score', sa.Float(), nullable=True),
    sa.Column('total_care_tokens', sa.Integer(), nullable=True, comment='Total CARE tokens earned (token economy integration)'),
    sa.Column('bio', sa.Text(), nullable=True, comment='User bio / about me (unlimited length)'),
    sa.Column('interests', sa.ARRAY(sa.String()), nullable=True, comment="List of interests (e.g., ['music', 'sports', 'reading'])"),
    sa.Column('created_at', sa.Date(), server_default=sa.text('CURRENT_DATE'), nullable=False),
    sa.Column('updated_at', sa.Date(), server_default=sa.text('CURRENT_DATE'), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_profiles_id'), 'user_profiles', ['id'], unique=False)
    op.create_index(op.f('ix_user_profiles_student_id'), 'user_profiles', ['student_id'], unique=True)
    op.create_index(op.f('ix_user_profiles_user_id'), 'user_profiles', ['user_id'], unique=True)
    op.create_table('user_sessions',
    sa.Column('id', sa.String(length=255), nullable=False, comment='Session token (used in Authorization header)'),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='FK to users table (one-to-many relationship)'),
    sa.Column('device_type', sa.String(length=50), nullable=True, comment="Device type: 'mobile', 'tablet', 'desktop', 'unknown'"),
    sa.Column('device_name', sa.String(length=200), nullable=True, comment="Device name/browser (e.g., 'Chrome 120.0', 'Safari iOS', 'Android App')"),
    sa.Column('ip_address', sa.String(length=45), nullable=True, comment='IP address of session'),
    sa.Column('user_agent', sa.String(length=500), nullable=True, comment='Browser/app user agent string'),
    sa.Column('location_city', sa.String(length=100), nullable=True, comment='Geographic location (city) - from IP geolocation'),
    sa.Column('location_country', sa.String(length=100), nullable=True, comment='Geographic location (country)'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='Whether session is currently active'),
    sa.Column('last_activity_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='Last activity timestamp (updated on each request)'),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False, comment='When session was created (login time)'),
    sa.Column('expires_at', sa.DateTime(timezone=True), nullable=False, comment='When session expires (for automatic cleanup)'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_sessions_expires_at'), 'user_sessions', ['expires_at'], unique=False)
    op.create_index(op.f('ix_user_sessions_ip_address'), 'user_sessions', ['ip_address'], unique=False)
    op.create_index(op.f('ix_user_sessions_is_active'), 'user_sessions', ['is_active'], unique=False)
    op.create_index(op.f('ix_user_sessions_user_id'), 'user_sessions', ['user_id'], unique=False)
    op.create_table('user_summaries',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('summarized_session_id', sa.String(), nullable=True),
    sa.Column('summary_text', sa.Text(), nullable=False),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_user_summaries_id'), 'user_summaries', ['id'], unique=False)
    op.create_index(op.f('ix_user_summaries_summarized_session_id'), 'user_summaries', ['summarized_session_id'], unique=False)
    op.create_index(op.f('ix_user_summaries_user_id'), 'user_summaries', ['user_id'], unique=False)
    op.create_table('agent_messages',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('run_id', sa.Integer(), nullable=False),
    sa.Column('agent_name', sa.String(length=64), nullable=False),
    sa.Column('role', sa.String(length=32), nullable=False),
    sa.Column('message_type', sa.String(length=32), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('metadata', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['run_id'], ['agent_runs.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_agent_messages_agent_name'), 'agent_messages', ['agent_name'], unique=False)
    op.create_index(op.f('ix_agent_messages_created_at'), 'agent_messages', ['created_at'], unique=False)
    op.create_index(op.f('ix_agent_messages_id'), 'agent_messages', ['id'], unique=False)
    op.create_index(op.f('ix_agent_messages_run_id'), 'agent_messages', ['run_id'], unique=False)
    op.create_table('appointments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('psychologist_id', sa.Integer(), nullable=False),
    sa.Column('appointment_type_id', sa.Integer(), nullable=False),
    sa.Column('appointment_datetime', sa.DateTime(), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['appointment_type_id'], ['appointment_types.id'], ),
    sa.ForeignKeyConstraint(['psychologist_id'], ['psychologists.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_appointments_id'), 'appointments', ['id'], unique=False)
    op.create_table('attestation_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('quest_instance_id', sa.Integer(), nullable=True),
    sa.Column('counselor_id', sa.Integer(), nullable=False),
    sa.Column('hashed_payload', sa.String(length=256), nullable=False),
    sa.Column('status', sa.Enum('pending', 'queued', 'confirmed', 'failed', name='attestationstatusenum'), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('processed_at', sa.DateTime(), nullable=True),
    sa.Column('last_error', sa.Text(), nullable=True),
    sa.Column('extra_data', sa.JSON(), nullable=False),
    sa.ForeignKeyConstraint(['counselor_id'], ['users.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['quest_instance_id'], ['quest_instances.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index('ix_attestation_status', 'attestation_records', ['status'], unique=False)
    op.create_table('campaign_metrics',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('campaign_id', sa.UUID(), nullable=False),
    sa.Column('execution_date', sa.Date(), nullable=False),
    sa.Column('messages_sent', sa.Integer(), nullable=False),
    sa.Column('users_targeted', sa.Integer(), nullable=False),
    sa.Column('users_engaged', sa.Integer(), nullable=False),
    sa.Column('success_rate', sa.Float(), nullable=True),
    sa.Column('avg_sentiment_before', sa.Float(), nullable=True),
    sa.Column('avg_sentiment_after', sa.Float(), nullable=True),
    sa.ForeignKeyConstraint(['campaign_id'], ['campaigns.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_campaign_metrics_campaign_id'), 'campaign_metrics', ['campaign_id'], unique=False)
    op.create_index(op.f('ix_campaign_metrics_execution_date'), 'campaign_metrics', ['execution_date'], unique=False)
    op.create_table('campaign_triggers',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('campaign_id', sa.UUID(), nullable=False),
    sa.Column('condition_type', sa.String(length=100), nullable=False),
    sa.Column('condition_value', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column('evaluation_frequency', sa.String(length=50), nullable=False),
    sa.Column('last_evaluated_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('last_match_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('match_count', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['campaign_id'], ['campaigns.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_campaign_triggers_campaign_id'), 'campaign_triggers', ['campaign_id'], unique=False)
    op.create_table('cases',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('status', sa.Enum('new', 'in_progress', 'waiting', 'resolved', 'closed', name='case_status_enum'), nullable=False),
    sa.Column('severity', sa.Enum('low', 'med', 'high', 'critical', name='case_severity_enum'), nullable=False),
    sa.Column('assigned_to', sa.String(), nullable=True),
    sa.Column('user_hash', sa.String(), nullable=False),
    sa.Column('session_id', sa.String(), nullable=True),
    sa.Column('conversation_id', sa.Integer(), nullable=True),
    sa.Column('summary_redacted', sa.Text(), nullable=True),
    sa.Column('sla_breach_at', sa.DateTime(timezone=True), nullable=True),
    sa.Column('closure_reason', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['assigned_to'], ['agent_users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['conversation_id'], ['conversations.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_cases_assigned_to'), 'cases', ['assigned_to'], unique=False)
    op.create_table('intervention_plan_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('session_id', sa.String(length=255), nullable=True),
    sa.Column('conversation_id', sa.Integer(), nullable=True),
    sa.Column('plan_title', sa.String(length=500), nullable=False),
    sa.Column('risk_level', sa.Integer(), nullable=True),
    sa.Column('plan_data', sa.JSON(), nullable=False),
    sa.Column('total_steps', sa.Integer(), nullable=False),
    sa.Column('completed_steps', sa.Integer(), nullable=False),
    sa.Column('completion_tracking', sa.JSON(), nullable=False),
    sa.Column('status', sa.String(length=50), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('archived_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.Column('last_viewed_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['conversation_id'], ['conversations.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_intervention_plan_records_conversation_id'), 'intervention_plan_records', ['conversation_id'], unique=False)
    op.create_index(op.f('ix_intervention_plan_records_created_at'), 'intervention_plan_records', ['created_at'], unique=False)
    op.create_index(op.f('ix_intervention_plan_records_id'), 'intervention_plan_records', ['id'], unique=False)
    op.create_index(op.f('ix_intervention_plan_records_session_id'), 'intervention_plan_records', ['session_id'], unique=False)
    op.create_index(op.f('ix_intervention_plan_records_status'), 'intervention_plan_records', ['status'], unique=False)
    op.create_index(op.f('ix_intervention_plan_records_user_id'), 'intervention_plan_records', ['user_id'], unique=False)
    op.create_table('journal_reflection_points',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('journal_entry_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('reflection_text', sa.Text(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['journal_entry_id'], ['journal_entries.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_journal_reflection_points_id'), 'journal_reflection_points', ['id'], unique=False)
    op.create_index(op.f('ix_journal_reflection_points_journal_entry_id'), 'journal_reflection_points', ['journal_entry_id'], unique=False)
    op.create_index(op.f('ix_journal_reflection_points_user_id'), 'journal_reflection_points', ['user_id'], unique=False)
    op.create_table('langgraph_executions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('execution_id', sa.String(), nullable=False),
    sa.Column('agent_run_id', sa.Integer(), nullable=True),
    sa.Column('graph_name', sa.String(), nullable=True),
    sa.Column('started_at', sa.DateTime(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('total_execution_time_ms', sa.Float(), nullable=True),
    sa.Column('total_nodes_executed', sa.Integer(), nullable=False),
    sa.Column('failed_nodes', sa.Integer(), nullable=False),
    sa.Column('success_rate', sa.Float(), nullable=True),
    sa.Column('input_data', sa.JSON(), nullable=True),
    sa.Column('output_data', sa.JSON(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('execution_context', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['agent_run_id'], ['agent_runs.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_langgraph_executions_execution_id'), 'langgraph_executions', ['execution_id'], unique=True)
    op.create_index(op.f('ix_langgraph_executions_graph_name'), 'langgraph_executions', ['graph_name'], unique=False)
    op.create_index(op.f('ix_langgraph_executions_id'), 'langgraph_executions', ['id'], unique=False)
    op.create_table('quest_analytics_events',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('event_type', sa.String(length=64), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('quest_instance_id', sa.Integer(), nullable=True),
    sa.Column('payload', sa.JSON(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['quest_instance_id'], ['quest_instances.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_quest_analytics_events_quest_instance_id'), 'quest_analytics_events', ['quest_instance_id'], unique=False)
    op.create_index(op.f('ix_quest_analytics_events_user_id'), 'quest_analytics_events', ['user_id'], unique=False)
    op.create_table('reward_ledger_entries',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('quest_instance_id', sa.Integer(), nullable=True),
    sa.Column('xp_awarded', sa.Integer(), nullable=False),
    sa.Column('joy_awarded', sa.Integer(), nullable=False),
    sa.Column('harmony_delta', sa.Float(), nullable=False),
    sa.Column('care_pending', sa.Float(), nullable=False),
    sa.Column('extra_data', sa.JSON(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['quest_instance_id'], ['quest_instances.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('quest_instance_id', name='uq_reward_ledger_quest_instance')
    )
    op.create_index(op.f('ix_reward_ledger_entries_quest_instance_id'), 'reward_ledger_entries', ['quest_instance_id'], unique=False)
    op.create_index(op.f('ix_reward_ledger_entries_user_id'), 'reward_ledger_entries', ['user_id'], unique=False)
    op.create_table('sca_campaign_executions',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('campaign_id', sa.UUID(), nullable=False),
    sa.Column('executed_at', sa.DateTime(timezone=True), server_default='now()', nullable=False),
    sa.Column('executed_by', sa.Integer(), nullable=True),
    sa.Column('campaign_name', sa.String(length=255), nullable=False),
    sa.Column('message_content', sa.Text(), nullable=False),
    sa.Column('total_targeted', sa.Integer(), nullable=False),
    sa.Column('messages_sent', sa.Integer(), nullable=False),
    sa.Column('messages_failed', sa.Integer(), nullable=False),
    sa.Column('execution_time_seconds', sa.Float(), nullable=False),
    sa.Column('dry_run', sa.Boolean(), nullable=False),
    sa.Column('targeted_user_ids', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['campaign_id'], ['campaigns.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['executed_by'], ['users.id'], ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_sca_campaign_executions_campaign_id'), 'sca_campaign_executions', ['campaign_id'], unique=False)
    op.create_index(op.f('ix_sca_campaign_executions_executed_at'), 'sca_campaign_executions', ['executed_at'], unique=False)
    op.create_table('survey_answers',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('response_id', sa.Integer(), nullable=False),
    sa.Column('question_id', sa.Integer(), nullable=False),
    sa.Column('answer_text', sa.Text(), nullable=False),
    sa.ForeignKeyConstraint(['question_id'], ['survey_questions.id'], ),
    sa.ForeignKeyConstraint(['response_id'], ['survey_responses.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_survey_answers_id'), 'survey_answers', ['id'], unique=False)
    op.create_table('triage_assessments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('conversation_id', sa.Integer(), nullable=True),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('risk_score', sa.Float(), nullable=False),
    sa.Column('confidence_score', sa.Float(), nullable=False),
    sa.Column('severity_level', sa.String(length=50), nullable=False),
    sa.Column('risk_factors', sa.JSON(), nullable=True),
    sa.Column('recommended_action', sa.String(length=100), nullable=True),
    sa.Column('assessment_data', sa.JSON(), nullable=True),
    sa.Column('processing_time_ms', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['conversation_id'], ['conversations.id'], ),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_triage_assessments_conversation_id'), 'triage_assessments', ['conversation_id'], unique=False)
    op.create_index(op.f('ix_triage_assessments_created_at'), 'triage_assessments', ['created_at'], unique=False)
    op.create_index(op.f('ix_triage_assessments_id'), 'triage_assessments', ['id'], unique=False)
    op.create_index(op.f('ix_triage_assessments_severity_level'), 'triage_assessments', ['severity_level'], unique=False)
    op.create_index(op.f('ix_triage_assessments_user_id'), 'triage_assessments', ['user_id'], unique=False)
    op.create_table('case_assignments',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('case_id', sa.UUID(), nullable=False),
    sa.Column('assigned_to', sa.String(length=255), nullable=True),
    sa.Column('assigned_by', sa.Integer(), nullable=True),
    sa.Column('assigned_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('reassignment_reason', sa.Text(), nullable=True),
    sa.Column('previous_assignee', sa.String(length=255), nullable=True),
    sa.ForeignKeyConstraint(['assigned_by'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['assigned_to'], ['agent_users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['case_id'], ['cases.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_case_assignments_assigned_to'), 'case_assignments', ['assigned_to'], unique=False)
    op.create_index(op.f('ix_case_assignments_case_id'), 'case_assignments', ['case_id'], unique=False)
    op.create_table('case_notes',
    sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
    sa.Column('case_id', sa.UUID(), nullable=False),
    sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
    sa.Column('author_id', sa.Integer(), nullable=True),
    sa.Column('note', sa.Text(), nullable=False),
    sa.ForeignKeyConstraint(['author_id'], ['users.id'], ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['case_id'], ['cases.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_case_notes_author_id'), 'case_notes', ['author_id'], unique=False)
    op.create_index(op.f('ix_case_notes_case_id'), 'case_notes', ['case_id'], unique=False)
    op.create_table('intervention_plan_step_completions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('plan_id', sa.Integer(), nullable=False),
    sa.Column('step_index', sa.Integer(), nullable=False),
    sa.Column('step_title', sa.String(length=500), nullable=False),
    sa.Column('completed', sa.Boolean(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['plan_id'], ['intervention_plan_records.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_intervention_plan_step_completions_id'), 'intervention_plan_step_completions', ['id'], unique=False)
    op.create_index(op.f('ix_intervention_plan_step_completions_plan_id'), 'intervention_plan_step_completions', ['plan_id'], unique=False)
    op.create_table('langgraph_alerts',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('execution_id', sa.String(), nullable=True),
    sa.Column('alert_type', sa.String(), nullable=False),
    sa.Column('severity', sa.String(), nullable=False),
    sa.Column('title', sa.String(), nullable=False),
    sa.Column('message', sa.Text(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('resolved_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('threshold_value', sa.Float(), nullable=True),
    sa.Column('actual_value', sa.Float(), nullable=True),
    sa.Column('metric_name', sa.String(), nullable=True),
    sa.Column('affected_nodes', sa.JSON(), nullable=True),
    sa.Column('alert_context', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['execution_id'], ['langgraph_executions.execution_id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_langgraph_alerts_alert_type'), 'langgraph_alerts', ['alert_type'], unique=False)
    op.create_index(op.f('ix_langgraph_alerts_id'), 'langgraph_alerts', ['id'], unique=False)
    op.create_index(op.f('ix_langgraph_alerts_severity'), 'langgraph_alerts', ['severity'], unique=False)
    op.create_table('langgraph_edge_executions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('execution_id', sa.String(), nullable=False),
    sa.Column('edge_id', sa.String(), nullable=False),
    sa.Column('source_node_id', sa.String(), nullable=False),
    sa.Column('target_node_id', sa.String(), nullable=False),
    sa.Column('edge_type', sa.String(), nullable=False),
    sa.Column('triggered_at', sa.DateTime(), nullable=False),
    sa.Column('evaluation_result', sa.Boolean(), nullable=True),
    sa.Column('condition_expression', sa.Text(), nullable=True),
    sa.Column('condition_context', sa.JSON(), nullable=True),
    sa.Column('evaluation_time_ms', sa.Float(), nullable=True),
    sa.Column('data_passed', sa.JSON(), nullable=True),
    sa.Column('execution_order', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['execution_id'], ['langgraph_executions.execution_id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_langgraph_edge_executions_edge_id'), 'langgraph_edge_executions', ['edge_id'], unique=False)
    op.create_index(op.f('ix_langgraph_edge_executions_id'), 'langgraph_edge_executions', ['id'], unique=False)
    op.create_table('langgraph_node_executions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('execution_id', sa.String(), nullable=False),
    sa.Column('node_id', sa.String(), nullable=False),
    sa.Column('agent_id', sa.String(), nullable=True),
    sa.Column('node_type', sa.String(), nullable=True),
    sa.Column('started_at', sa.DateTime(), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.Column('status', sa.String(), nullable=False),
    sa.Column('execution_time_ms', sa.Float(), nullable=True),
    sa.Column('memory_usage_mb', sa.Float(), nullable=True),
    sa.Column('cpu_usage_percent', sa.Float(), nullable=True),
    sa.Column('input_data', sa.JSON(), nullable=True),
    sa.Column('output_data', sa.JSON(), nullable=True),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('error_stack_trace', sa.Text(), nullable=True),
    sa.Column('retry_count', sa.Integer(), nullable=False),
    sa.Column('execution_order', sa.Integer(), nullable=True),
    sa.Column('parent_node_id', sa.String(), nullable=True),
    sa.Column('custom_metrics', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['execution_id'], ['langgraph_executions.execution_id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_langgraph_node_executions_agent_id'), 'langgraph_node_executions', ['agent_id'], unique=False)
    op.create_index(op.f('ix_langgraph_node_executions_id'), 'langgraph_node_executions', ['id'], unique=False)
    op.create_index(op.f('ix_langgraph_node_executions_node_id'), 'langgraph_node_executions', ['node_id'], unique=False)
    op.create_table('langgraph_performance_metrics',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('execution_id', sa.String(), nullable=False),
    sa.Column('metric_name', sa.String(), nullable=False),
    sa.Column('metric_category', sa.String(), nullable=True),
    sa.Column('metric_value', sa.Float(), nullable=False),
    sa.Column('metric_unit', sa.String(), nullable=True),
    sa.Column('recorded_at', sa.DateTime(), nullable=False),
    sa.Column('node_id', sa.String(), nullable=True),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['execution_id'], ['langgraph_executions.execution_id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_langgraph_performance_metrics_id'), 'langgraph_performance_metrics', ['id'], unique=False)
    op.create_index(op.f('ix_langgraph_performance_metrics_metric_category'), 'langgraph_performance_metrics', ['metric_category'], unique=False)
    op.create_index(op.f('ix_langgraph_performance_metrics_metric_name'), 'langgraph_performance_metrics', ['metric_name'], unique=False)
    # ### end Alembic commands ###


def schema_downgrade() -> None:
    """
    Revert schema changes with idempotent checks.
    
    Example patterns:
    
    # Dropping columns
    if mh and mh.column_exists('my_table', 'my_column'):
        op.drop_column('my_table', 'my_column')
    
    # Dropping tables
    if mh and mh.table_exists('my_table'):
        op.drop_table('my_table')
    
    # Or use helper functions:
    if mh:
        mh.drop_column_if_exists('my_table', 'my_column')
    """
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_langgraph_performance_metrics_metric_name'), table_name='langgraph_performance_metrics')
    op.drop_index(op.f('ix_langgraph_performance_metrics_metric_category'), table_name='langgraph_performance_metrics')
    op.drop_index(op.f('ix_langgraph_performance_metrics_id'), table_name='langgraph_performance_metrics')
    op.drop_table('langgraph_performance_metrics')
    op.drop_index(op.f('ix_langgraph_node_executions_node_id'), table_name='langgraph_node_executions')
    op.drop_index(op.f('ix_langgraph_node_executions_id'), table_name='langgraph_node_executions')
    op.drop_index(op.f('ix_langgraph_node_executions_agent_id'), table_name='langgraph_node_executions')
    op.drop_table('langgraph_node_executions')
    op.drop_index(op.f('ix_langgraph_edge_executions_id'), table_name='langgraph_edge_executions')
    op.drop_index(op.f('ix_langgraph_edge_executions_edge_id'), table_name='langgraph_edge_executions')
    op.drop_table('langgraph_edge_executions')
    op.drop_index(op.f('ix_langgraph_alerts_severity'), table_name='langgraph_alerts')
    op.drop_index(op.f('ix_langgraph_alerts_id'), table_name='langgraph_alerts')
    op.drop_index(op.f('ix_langgraph_alerts_alert_type'), table_name='langgraph_alerts')
    op.drop_table('langgraph_alerts')
    op.drop_index(op.f('ix_intervention_plan_step_completions_plan_id'), table_name='intervention_plan_step_completions')
    op.drop_index(op.f('ix_intervention_plan_step_completions_id'), table_name='intervention_plan_step_completions')
    op.drop_table('intervention_plan_step_completions')
    op.drop_index(op.f('ix_case_notes_case_id'), table_name='case_notes')
    op.drop_index(op.f('ix_case_notes_author_id'), table_name='case_notes')
    op.drop_table('case_notes')
    op.drop_index(op.f('ix_case_assignments_case_id'), table_name='case_assignments')
    op.drop_index(op.f('ix_case_assignments_assigned_to'), table_name='case_assignments')
    op.drop_table('case_assignments')
    op.drop_index(op.f('ix_triage_assessments_user_id'), table_name='triage_assessments')
    op.drop_index(op.f('ix_triage_assessments_severity_level'), table_name='triage_assessments')
    op.drop_index(op.f('ix_triage_assessments_id'), table_name='triage_assessments')
    op.drop_index(op.f('ix_triage_assessments_created_at'), table_name='triage_assessments')
    op.drop_index(op.f('ix_triage_assessments_conversation_id'), table_name='triage_assessments')
    op.drop_table('triage_assessments')
    op.drop_index(op.f('ix_survey_answers_id'), table_name='survey_answers')
    op.drop_table('survey_answers')
    op.drop_index(op.f('ix_sca_campaign_executions_executed_at'), table_name='sca_campaign_executions')
    op.drop_index(op.f('ix_sca_campaign_executions_campaign_id'), table_name='sca_campaign_executions')
    op.drop_table('sca_campaign_executions')
    op.drop_index(op.f('ix_reward_ledger_entries_user_id'), table_name='reward_ledger_entries')
    op.drop_index(op.f('ix_reward_ledger_entries_quest_instance_id'), table_name='reward_ledger_entries')
    op.drop_table('reward_ledger_entries')
    op.drop_index(op.f('ix_quest_analytics_events_user_id'), table_name='quest_analytics_events')
    op.drop_index(op.f('ix_quest_analytics_events_quest_instance_id'), table_name='quest_analytics_events')
    op.drop_table('quest_analytics_events')
    op.drop_index(op.f('ix_langgraph_executions_id'), table_name='langgraph_executions')
    op.drop_index(op.f('ix_langgraph_executions_graph_name'), table_name='langgraph_executions')
    op.drop_index(op.f('ix_langgraph_executions_execution_id'), table_name='langgraph_executions')
    op.drop_table('langgraph_executions')
    op.drop_index(op.f('ix_journal_reflection_points_user_id'), table_name='journal_reflection_points')
    op.drop_index(op.f('ix_journal_reflection_points_journal_entry_id'), table_name='journal_reflection_points')
    op.drop_index(op.f('ix_journal_reflection_points_id'), table_name='journal_reflection_points')
    op.drop_table('journal_reflection_points')
    op.drop_index(op.f('ix_intervention_plan_records_user_id'), table_name='intervention_plan_records')
    op.drop_index(op.f('ix_intervention_plan_records_status'), table_name='intervention_plan_records')
    op.drop_index(op.f('ix_intervention_plan_records_session_id'), table_name='intervention_plan_records')
    op.drop_index(op.f('ix_intervention_plan_records_id'), table_name='intervention_plan_records')
    op.drop_index(op.f('ix_intervention_plan_records_created_at'), table_name='intervention_plan_records')
    op.drop_index(op.f('ix_intervention_plan_records_conversation_id'), table_name='intervention_plan_records')
    op.drop_table('intervention_plan_records')
    op.drop_index(op.f('ix_cases_assigned_to'), table_name='cases')
    op.drop_table('cases')
    op.drop_index(op.f('ix_campaign_triggers_campaign_id'), table_name='campaign_triggers')
    op.drop_table('campaign_triggers')
    op.drop_index(op.f('ix_campaign_metrics_execution_date'), table_name='campaign_metrics')
    op.drop_index(op.f('ix_campaign_metrics_campaign_id'), table_name='campaign_metrics')
    op.drop_table('campaign_metrics')
    op.drop_index('ix_attestation_status', table_name='attestation_records')
    op.drop_table('attestation_records')
    op.drop_index(op.f('ix_appointments_id'), table_name='appointments')
    op.drop_table('appointments')
    op.drop_index(op.f('ix_agent_messages_run_id'), table_name='agent_messages')
    op.drop_index(op.f('ix_agent_messages_id'), table_name='agent_messages')
    op.drop_index(op.f('ix_agent_messages_created_at'), table_name='agent_messages')
    op.drop_index(op.f('ix_agent_messages_agent_name'), table_name='agent_messages')
    op.drop_table('agent_messages')
    op.drop_index(op.f('ix_user_summaries_user_id'), table_name='user_summaries')
    op.drop_index(op.f('ix_user_summaries_summarized_session_id'), table_name='user_summaries')
    op.drop_index(op.f('ix_user_summaries_id'), table_name='user_summaries')
    op.drop_table('user_summaries')
    op.drop_index(op.f('ix_user_sessions_user_id'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_is_active'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_ip_address'), table_name='user_sessions')
    op.drop_index(op.f('ix_user_sessions_expires_at'), table_name='user_sessions')
    op.drop_table('user_sessions')
    op.drop_index(op.f('ix_user_profiles_user_id'), table_name='user_profiles')
    op.drop_index(op.f('ix_user_profiles_student_id'), table_name='user_profiles')
    op.drop_index(op.f('ix_user_profiles_id'), table_name='user_profiles')
    op.drop_table('user_profiles')
    op.drop_index(op.f('ix_user_preferences_user_id'), table_name='user_preferences')
    op.drop_index(op.f('ix_user_preferences_id'), table_name='user_preferences')
    op.drop_index(op.f('ix_user_preferences_check_in_code'), table_name='user_preferences')
    op.drop_table('user_preferences')
    op.drop_index(op.f('ix_user_emergency_contacts_user_id'), table_name='user_emergency_contacts')
    op.drop_index(op.f('ix_user_emergency_contacts_priority'), table_name='user_emergency_contacts')
    op.drop_index(op.f('ix_user_emergency_contacts_is_active'), table_name='user_emergency_contacts')
    op.drop_index(op.f('ix_user_emergency_contacts_id'), table_name='user_emergency_contacts')
    op.drop_table('user_emergency_contacts')
    op.drop_index(op.f('ix_user_consent_ledger_user_id'), table_name='user_consent_ledger')
    op.drop_index(op.f('ix_user_consent_ledger_timestamp'), table_name='user_consent_ledger')
    op.drop_index(op.f('ix_user_consent_ledger_id'), table_name='user_consent_ledger')
    op.drop_index(op.f('ix_user_consent_ledger_granted'), table_name='user_consent_ledger')
    op.drop_index(op.f('ix_user_consent_ledger_consent_type'), table_name='user_consent_ledger')
    op.drop_table('user_consent_ledger')
    op.drop_index(op.f('ix_user_clinical_records_user_id'), table_name='user_clinical_records')
    op.drop_index(op.f('ix_user_clinical_records_last_risk_assessment_date'), table_name='user_clinical_records')
    op.drop_index(op.f('ix_user_clinical_records_id'), table_name='user_clinical_records')
    op.drop_index(op.f('ix_user_clinical_records_flagged_for_review'), table_name='user_clinical_records')
    op.drop_index(op.f('ix_user_clinical_records_current_risk_level'), table_name='user_clinical_records')
    op.drop_table('user_clinical_records')
    op.drop_index(op.f('ix_user_badges_user_id'), table_name='user_badges')
    op.drop_index(op.f('ix_user_badges_id'), table_name='user_badges')
    op.drop_index(op.f('ix_user_badges_contract_address'), table_name='user_badges')
    op.drop_index(op.f('ix_user_badges_badge_id'), table_name='user_badges')
    op.drop_table('user_badges')
    op.drop_index(op.f('ix_user_audit_log_user_id'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_timestamp'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_table_name'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_session_id'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_request_id'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_id'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_changed_by_user_id'), table_name='user_audit_log')
    op.drop_index(op.f('ix_user_audit_log_action'), table_name='user_audit_log')
    op.drop_table('user_audit_log')
    op.drop_index(op.f('ix_transactions_user_id'), table_name='transactions')
    op.drop_index(op.f('ix_transactions_transaction_type'), table_name='transactions')
    op.drop_index(op.f('ix_transactions_status'), table_name='transactions')
    op.drop_index(op.f('ix_transactions_id'), table_name='transactions')
    op.drop_index(op.f('ix_transactions_created_at'), table_name='transactions')
    op.drop_table('transactions')
    op.drop_index(op.f('ix_therapist_schedules_id'), table_name='therapist_schedules')
    op.drop_table('therapist_schedules')
    op.drop_index(op.f('ix_system_settings_category'), table_name='system_settings')
    op.drop_table('system_settings')
    op.drop_index(op.f('ix_survey_responses_id'), table_name='survey_responses')
    op.drop_table('survey_responses')
    op.drop_index(op.f('ix_survey_questions_id'), table_name='survey_questions')
    op.drop_table('survey_questions')
    op.drop_index(op.f('ix_subscriptions_user_id'), table_name='subscriptions')
    op.drop_index(op.f('ix_subscriptions_status'), table_name='subscriptions')
    op.drop_index(op.f('ix_subscriptions_id'), table_name='subscriptions')
    op.drop_index(op.f('ix_subscriptions_billing_date'), table_name='subscriptions')
    op.drop_table('subscriptions')
    op.drop_index(op.f('ix_revenue_approvals_report_id'), table_name='revenue_approvals')
    op.drop_index(op.f('ix_revenue_approvals_id'), table_name='revenue_approvals')
    op.drop_table('revenue_approvals')
    op.drop_index('ix_quest_instances_user_status', table_name='quest_instances')
    op.drop_index('ix_quest_instances_expires_at', table_name='quest_instances')
    op.drop_table('quest_instances')
    op.drop_index(op.f('ix_psychologists_user_id'), table_name='psychologists')
    op.drop_index(op.f('ix_psychologists_is_available'), table_name='psychologists')
    op.drop_index(op.f('ix_psychologists_id'), table_name='psychologists')
    op.drop_table('psychologists')
    op.drop_table('player_wellness_state')
    op.drop_index(op.f('ix_nft_transactions_user_id'), table_name='nft_transactions')
    op.drop_index(op.f('ix_nft_transactions_status'), table_name='nft_transactions')
    op.drop_index(op.f('ix_nft_transactions_id'), table_name='nft_transactions')
    op.drop_index(op.f('ix_nft_transactions_created_at'), table_name='nft_transactions')
    op.drop_table('nft_transactions')
    op.drop_index(op.f('ix_journal_entries_user_id'), table_name='journal_entries')
    op.drop_index(op.f('ix_journal_entries_id'), table_name='journal_entries')
    op.drop_index(op.f('ix_journal_entries_entry_date'), table_name='journal_entries')
    op.drop_table('journal_entries')
    op.drop_index(op.f('ix_flagged_sessions_user_id'), table_name='flagged_sessions')
    op.drop_index(op.f('ix_flagged_sessions_status'), table_name='flagged_sessions')
    op.drop_index(op.f('ix_flagged_sessions_session_id'), table_name='flagged_sessions')
    op.drop_index(op.f('ix_flagged_sessions_id'), table_name='flagged_sessions')
    op.drop_index(op.f('ix_flagged_sessions_flagged_by_admin_id'), table_name='flagged_sessions')
    op.drop_table('flagged_sessions')
    op.drop_index(op.f('ix_feedback_user_id'), table_name='feedback')
    op.drop_index(op.f('ix_feedback_session_id'), table_name='feedback')
    op.drop_index(op.f('ix_feedback_id'), table_name='feedback')
    op.drop_table('feedback')
    op.drop_index(op.f('ix_conversations_session_id'), table_name='conversations')
    op.drop_index(op.f('ix_conversations_id'), table_name='conversations')
    op.drop_index(op.f('ix_conversations_conversation_id'), table_name='conversations')
    op.drop_table('conversations')
    op.drop_index(op.f('ix_conversation_risk_assessments_user_id'), table_name='conversation_risk_assessments')
    op.drop_index(op.f('ix_conversation_risk_assessments_session_id'), table_name='conversation_risk_assessments')
    op.drop_index(op.f('ix_conversation_risk_assessments_id'), table_name='conversation_risk_assessments')
    op.drop_index(op.f('ix_conversation_risk_assessments_conversation_id'), table_name='conversation_risk_assessments')
    op.drop_table('conversation_risk_assessments')
    op.drop_table('compliance_audit_log')
    op.drop_index(op.f('ix_cbt_module_steps_id'), table_name='cbt_module_steps')
    op.drop_table('cbt_module_steps')
    op.drop_index(op.f('ix_campaigns_status'), table_name='campaigns')
    op.drop_table('campaigns')
    op.drop_index(op.f('ix_campaign_executions_user_id'), table_name='campaign_executions')
    op.drop_index(op.f('ix_campaign_executions_status'), table_name='campaign_executions')
    op.drop_index(op.f('ix_campaign_executions_id'), table_name='campaign_executions')
    op.drop_index(op.f('ix_campaign_executions_campaign_id'), table_name='campaign_executions')
    op.drop_table('campaign_executions')
    op.drop_index(op.f('ix_agent_runs_triggered_by_user_id'), table_name='agent_runs')
    op.drop_index(op.f('ix_agent_runs_status'), table_name='agent_runs')
    op.drop_index(op.f('ix_agent_runs_id'), table_name='agent_runs')
    op.drop_index(op.f('ix_agent_runs_correlation_id'), table_name='agent_runs')
    op.drop_index(op.f('ix_agent_runs_agent_name'), table_name='agent_runs')
    op.drop_index(op.f('ix_agent_runs_action'), table_name='agent_runs')
    op.drop_table('agent_runs')
    op.drop_index(op.f('ix_users_wallet_address'), table_name='users')
    op.drop_index(op.f('ix_users_twitter_id'), table_name='users')
    op.drop_index(op.f('ix_users_id'), table_name='users')
    op.drop_index(op.f('ix_users_google_sub'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_table('users')
    op.drop_index(op.f('ix_tweets_tweet_id'), table_name='tweets')
    op.drop_index(op.f('ix_tweets_id'), table_name='tweets')
    op.drop_table('tweets')
    op.drop_index(op.f('ix_surveys_id'), table_name='surveys')
    op.drop_table('surveys')
    op.drop_index(op.f('ix_revenue_reports_year'), table_name='revenue_reports')
    op.drop_index(op.f('ix_revenue_reports_transaction_hash'), table_name='revenue_reports')
    op.drop_index(op.f('ix_revenue_reports_month_yyyymm'), table_name='revenue_reports')
    op.drop_index(op.f('ix_revenue_reports_month'), table_name='revenue_reports')
    op.drop_index(op.f('ix_revenue_reports_id'), table_name='revenue_reports')
    op.drop_table('revenue_reports')
    op.drop_table('resources')
    op.drop_table('quest_templates')
    op.drop_index(op.f('ix_partner_transactions_status'), table_name='partner_transactions')
    op.drop_index(op.f('ix_partner_transactions_id'), table_name='partner_transactions')
    op.drop_index(op.f('ix_partner_transactions_created_at'), table_name='partner_transactions')
    op.drop_table('partner_transactions')
    op.drop_index(op.f('ix_messages_ts'), table_name='messages')
    op.drop_index('ix_messages_tools_used', table_name='messages', postgresql_using='gin')
    op.drop_index(op.f('ix_messages_session_id'), table_name='messages')
    op.drop_table('messages')
    op.drop_index(op.f('ix_journal_prompts_id'), table_name='journal_prompts')
    op.drop_index(op.f('ix_journal_prompts_category'), table_name='journal_prompts')
    op.drop_table('journal_prompts')
    op.drop_index(op.f('ix_intervention_campaigns_status'), table_name='intervention_campaigns')
    op.drop_index(op.f('ix_intervention_campaigns_id'), table_name='intervention_campaigns')
    op.drop_table('intervention_campaigns')
    op.drop_index(op.f('ix_insights_reports_report_type'), table_name='insights_reports')
    op.drop_index(op.f('ix_insights_reports_generated_at'), table_name='insights_reports')
    op.drop_table('insights_reports')
    op.drop_index(op.f('ix_events_user_hash'), table_name='events')
    op.drop_index('ix_events_risk_flag_created_at', table_name='events')
    op.drop_index('ix_events_intent_created_at', table_name='events')
    op.drop_index(op.f('ix_events_created_at'), table_name='events')
    op.drop_index('ix_events_agent_created_at', table_name='events')
    op.drop_table('events')
    op.drop_index(op.f('ix_content_resources_id'), table_name='content_resources')
    op.drop_table('content_resources')
    op.drop_table('consents')
    op.drop_index(op.f('ix_cbt_modules_id'), table_name='cbt_modules')
    op.drop_table('cbt_modules')
    op.drop_index(op.f('ix_appointment_types_id'), table_name='appointment_types')
    op.drop_table('appointment_types')
    op.drop_index(op.f('ix_alerts_severity'), table_name='alerts')
    op.drop_index(op.f('ix_alerts_is_seen'), table_name='alerts')
    op.drop_index(op.f('ix_alerts_entity_id'), table_name='alerts')
    op.drop_index(op.f('ix_alerts_created_at'), table_name='alerts')
    op.drop_index(op.f('ix_alerts_alert_type'), table_name='alerts')
    op.drop_table('alerts')
    op.drop_table('agent_users')
    op.drop_index(op.f('ix_agent_health_logs_status'), table_name='agent_health_logs')
    op.drop_index(op.f('ix_agent_health_logs_created_at'), table_name='agent_health_logs')
    op.drop_index(op.f('ix_agent_health_logs_agent_name'), table_name='agent_health_logs')
    op.drop_table('agent_health_logs')
    # ### end Alembic commands ###


def data_upgrade() -> None:
    """
    Idempotent data migrations executed with --x data=true.
    
    Use this for:
    - Populating new columns with computed values
    - Migrating data between tables
    - Seeding initial data
    
    IMPORTANT: Make this idempotent by checking for existing data first.
    
    Example:
        conn = op.get_bind()
        result = conn.execute(sa.text("SELECT COUNT(*) FROM my_table WHERE ..."))
        if result.scalar() == 0:
            # Safe to insert/update
            pass
    """
    pass


def data_downgrade() -> None:
    """
    Rollback for data migrations executed with --x data=true.
    
    IMPORTANT: Be careful with data downgrades - they can cause data loss.
    Consider logging or backing up before deletion.
    """
    pass


def _should_run_data_migrations() -> bool:
    """Return True when the revision is invoked with ``--x data=true``."""
    x_args: dict[str, Any] = context.get_x_argument(as_dictionary=True)
    flag = x_args.get("data")
    if isinstance(flag, str):
        return flag.lower() in {"1", "true", "yes", "on"}
    return bool(flag)


# Helper function for manual idempotency checks if migration_helpers unavailable
def _table_exists(table_name: str) -> bool:
    """Fallback table existence check."""
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    return table_name in inspector.get_table_names()


def _column_exists(table_name: str, column_name: str) -> bool:
    """Fallback column existence check."""
    if not _table_exists(table_name):
        return False
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    columns = {col['name'] for col in inspector.get_columns(table_name)}
    return column_name in columns

