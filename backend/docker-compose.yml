version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    # Cloud services required (set via Coolify env vars):
    # - DATABASE_URL
    # - REDIS_URL
    # - CELERY_BROKER_URL
    # - CELERY_RESULT_BACKEND
    # - MINIO_ENDPOINT
    # - MINIO_ACCESS_KEY
    # - MINIO_SECRET_KEY
    # - MINIO_BUCKET
    env_file:
      - .env
    ports:
      - "${BACKEND_EXTERNAL_PORT:-22001}:22001"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os,urllib.request; port=os.getenv(\"PORT\",\"22001\"); url=f\"http://127.0.0.1:{port}/health\"; urllib.request.urlopen(url, timeout=3).read()'"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

