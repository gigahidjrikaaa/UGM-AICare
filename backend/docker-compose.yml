version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    # Cloud services required (set via Coolify env vars):
    # - DATABASE_URL
    # - REDIS_URL
    # - CELERY_BROKER_URL
    # - CELERY_RESULT_BACKEND
    # - MINIO_ENDPOINT
    # - MINIO_ACCESS_KEY
    # - MINIO_SECRET_KEY
    # - MINIO_BUCKET
    env_file:
      - .env
    environment:
      PYTHONPATH: /app
      PORT: ${PORT:-22001}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
    ports:
      - "${BACKEND_EXTERNAL_PORT:-22001}:22001"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os,urllib.request; port=os.getenv(\"PORT\",\"22001\"); url=f\"http://127.0.0.1:{port}/health\"; urllib.request.urlopen(url, timeout=3).read()'"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      PYTHONPATH: /app
      PORT: ${PORT:-22001}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL}
      CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
    command: ["celery", "-A", "app.core.celery_app.celery_app", "worker", "-l", "info"]
    restart: unless-stopped
